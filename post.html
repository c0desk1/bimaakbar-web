<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Memuat Postingan...</title>
    <meta name="description" content="Sebuah artikel menarik yang sedang dimuat.">
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #a3a3a3; }
        .glass-header { background: rgba(10,10,10,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .prose-styles h2, .prose-styles h3 { scroll-margin-top: 5rem; color: #fafafa; font-weight: 700; margin-top: 2em; margin-bottom: 1em; }
        .prose-styles p { line-height: 1.75; margin-bottom: 1.25em; }
        .prose-styles a { color: #818cf8; text-decoration: underline; }
        .prose-styles blockquote { border-left: 3px solid #6366f1; padding-left: 1.5rem; margin: 1.5rem 0; font-style: italic; color: #d4d4d8; }
        .prose-styles img { border-radius: 0.75rem; margin: 2rem 0; }
        .comment-card { background-color: rgba(23, 23, 23, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); }
        .comment-form textarea { background-color: rgba(38, 38, 38, 0.8); border: 1px solid rgba(255,255,255,0.1); color: #e5e7eb; }
        .related-card:hover .related-img { transform: scale(1.05); }
    </style>
</head>
<body class="antialiased">

    <header class="glass-header sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-3 items-center h-16">
                <div class="justify-self-start"><a href="index.html" class="flex items-center space-x-2 text-gray-300 hover:text-white"><i class="ri-arrow-left-s-line text-xl"></i><span class="text-sm font-semibold hidden sm:block">Kembali</span></a></div>
                <div class="justify-self-center"><a href="index.html"><img src="assets/logo.png" alt="Logo" class="h-8 w-auto"></a></div>
                <div class="justify-self-end"><button id="native-share-btn" title="Bagikan" class="text-gray-300 hover:text-white p-2 rounded-full hover:bg-white/10"><i class="ri-share-line text-xl"></i></button></div>
            </div>
        </div>
    </header>

    <main id="mainContent" class="opacity-0 transition-opacity duration-500">
        <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
            <div id="post-container" style="display: none;">
                <header class="mb-8">
                    <p id="post-category" class="font-semibold text-indigo-400 uppercase tracking-wider text-sm"></p>
                    <h1 id="post-title" class="text-3xl md:text-5xl font-extrabold text-white mt-2"></h1>
                    <div id="post-meta" class="mt-4 text-sm text-gray-400 flex items-center flex-wrap gap-x-4 gap-y-2"></div>
                </header>
                <div id="table-of-contents" class="my-8 p-6 glass-card rounded-2xl" style="display: none;">
                    <h2 class="text-xl font-bold text-white mb-4 mt-0">Daftar Isi</h2>
                    <ul id="toc-list" class="space-y-2 list-disc list-inside text-indigo-300"></ul>
                </div>
                <img id="post-thumbnail" src="" alt="" class="w-full rounded-2xl shadow-lg mb-8 bg-neutral-800" style="display: none;">
                <div id="post-content" class="prose-styles text-lg"></div>
            </div>

            <div id="post-footer-features" style="display: none;">
                <section id="comments-section" class="mt-16 pt-12 border-t border-white/10">
                    <h2 class="text-2xl font-bold text-white mb-6">Komentar</h2>
                    <div id="comment-form-container" class="mb-8"></div>
                    <div id="comments-list" class="space-y-6"></div>
                </section>
                <nav id="post-navigation" class="mt-16 pt-8 border-t border-white/10 flex justify-between gap-4"></nav>
                <section id="related-posts" class="mt-16 pt-12 border-t border-white/10" style="display: none;">
                    <h2 class="text-2xl font-bold text-white mb-6">Baca Juga</h2>
                    <div id="related-posts-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6"></div>
                </section>
                <section id="newsletter" class="mt-16 pt-12 border-t border-white/10">
                    <div class="bg-neutral-900/50 rounded-2xl p-8 text-center"><h3 class="text-2xl font-bold text-white">Suka dengan Tulisan Ini?</h3>
                    <p class="text-gray-400 mt-2 max-w-lg mx-auto">Dapatkan notifikasi setiap kali ada konten baru.</p>
                    <form id="newsletterForm" class="mt-6 max-w-md mx-auto"><div class="flex flex-col sm:flex-row gap-3">
                        <input type="email" id="newsletterEmail" required placeholder="Masukkan email Anda" class="w-full px-4 py-3 rounded-lg bg-neutral-800 text-white border border-neutral-700">
                        <button type="submit" class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-600">Daftar</button>
                    </div><p id="newsletterMessage" class="text-xs mt-2 h-4"></p></form></div>
                </section>
            </div>
            
            <div id="notFound" class="hidden text-center py-20">
                <h1 class="text-6xl font-black text-white">404</h1><p class="text-xl mt-4 text-gray-400">Postingan tidak ditemukan.</p>
                <a href="index.html" class="mt-8 inline-block bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg">Kembali ke Beranda</a>
            </div>
        </article>
    </main>

    <footer class="text-center py-12 border-t border-white/10 mt-20">
        <p class="text-sm text-gray-500">&copy; 2025 Bima Akbar. All Rights Reserved.</p>
    </footer>
    <button id="back-to-top" class="hidden fixed bottom-6 right-6 bg-indigo-500 text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-600 transition-all z-50 justify-center items-center"><i class="ri-arrow-up-s-line text-2xl"></i></button>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const supabase = window.supabase.createClient('https://wgcslximcxnprmfqtsoh.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnY3NseGltY3hucHJtZnF0c29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTE5NzEsImV4cCI6MjA2NTMyNzk3MX0.K0xWAiVdU9vAwJepHV5rMBROBoBDTpXtczXoQopEZQk');
        
        const mainContent = document.getElementById('mainContent');
        const postContainer = document.getElementById('post-container');
        const notFoundDiv = document.getElementById('notFound');
        const commentsSection = document.getElementById('comments-section');
        const commentFormContainer = document.getElementById('comment-form-container');
        const newsletterForm = document.getElementById('newsletterForm');
        const backToTopBtn = document.getElementById('back-to-top');
        const postNavigation = document.getElementById('post-navigation');
        const relatedPosts = document.getElementById('related-posts');
        const newsletterSection = document.getElementById('newsletter');

        if(backToTopBtn) {
            window.onscroll = () => { (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) ? backToTopBtn.style.display = "flex" : backToTopBtn.style.display = "none"; };
            backToTopBtn.addEventListener('click', () => { window.scrollTo({top: 0, behavior: 'smooth'}); });
        }

        function updateMeta(post) {
            document.title = post.meta_title || post.title;
            const metaDesc = document.querySelector('meta[name="description"]');
            if (metaDesc) metaDesc.setAttribute('content', post.meta_description || '');
        }

        function displayPost(post) {
            document.getElementById('post-category').textContent = post.category || '';
            document.getElementById('post-title').textContent = post.title;
            const postMeta = document.getElementById('post-meta');
            postMeta.innerHTML = `<span>Oleh ${post.author || 'Anonim'}</span><span>•</span><span>${new Date(post.created_at).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'})}</span><span>•</span><span class="flex items-center"><i class="ri-eye-line mr-1"></i>${post.views || 0} views</span>`;
            const thumbnail = document.getElementById('post-thumbnail');
            if (post.thumbnail_url) { thumbnail.src = post.thumbnail_url; thumbnail.alt = post.title; thumbnail.style.display = 'block'; }
            const contentEl = document.getElementById('post-content');
            contentEl.innerHTML = post.content;
            return contentEl;
        }

        function setupShareButton(postTitle) {
            const shareBtn = document.getElementById('native-share-btn');
            if (!shareBtn) return;
            shareBtn.addEventListener('click', async () => {
                const shareData = { title: postTitle, text: `Cek artikel menarik: ${postTitle}`, url: window.location.href };
                try { if (navigator.share) await navigator.share(shareData); else throw new Error('Web Share tidak didukung.'); } 
                catch (err) { navigator.clipboard.writeText(window.location.href).then(() => alert('Link artikel berhasil disalin!')); }
            });
        }

        function calculateReadTime(contentElement) {
            if(!contentElement) return '';
            const text = contentElement.textContent || '';
            const wordCount = text.split(/\s+/).filter(Boolean).length;
            const minutes = Math.ceil(wordCount / 225);
            return `<span>•</span><span>☕️ ${minutes} menit baca</span>`;
        }

        function generateTableOfContents(contentElement) {
            const tocContainer = document.getElementById('table-of-contents');
            const tocList = document.getElementById('toc-list');
            if (!tocContainer || !tocList || !contentElement) return;
            const headings = contentElement.querySelectorAll('h2, h3');
            if (headings.length < 2) { tocContainer.style.display = 'none'; return; }
            tocList.innerHTML = '';
            headings.forEach((heading, index) => {
                const id = `heading-${index}`;
                heading.id = id;
                const listItem = document.createElement('li');
                if (heading.tagName === 'H3') listItem.classList.add('ml-4');
                listItem.innerHTML = `<a href="#${id}" class="hover:text-white">${heading.textContent}</a>`;
                tocList.appendChild(listItem);
            });
            tocContainer.style.display = 'block';
        }
        
        async function fetchPrevNextPosts(currentPost) { /* ... fungsi lengkap ... */ }
        async function fetchAndRenderRelatedPosts(currentPost) { /* ... fungsi lengkap ... */ }
        async function fetchAndRenderComments(postId) { /* ... fungsi lengkap ... */ }
        function renderCommentForm(postId, session) { /* ... fungsi lengkap ... */ }
        async function countView(postId) { /* ... fungsi lengkap ... */ }
        async function handleNewsletter(e) { /* ... fungsi lengkap ... */ }

        async function initializePage() {
            try {
                const slug = new URLSearchParams(window.location.search).get('slug');
                if (!slug) throw new Error("Slug tidak ditemukan di URL.");
                const { data: post, error } = await supabase.from('posts').select('*').eq('slug', slug).eq('published', true).single();
                if (error || !post) throw new Error("Postingan tidak ditemukan.");
                
                postContainer.style.display = 'block';
                commentsSection.style.display = 'block';
                postNavigation.style.display = 'flex';
                relatedPosts.style.display = 'block';
                newsletterSection.style.display = 'block';
                
                updateMeta(post);
                const contentEl = displayPost(post);
                setupShareButton(post.title);
                document.getElementById('post-meta').innerHTML += calculateReadTime(contentEl);
                generateTableOfContents(contentEl);
                const { data: { session } } = await supabase.auth.getSession();
                renderCommentForm(post.id, session);
                fetchAndRenderComments(post.id);
                fetchPrevNextPosts(post);
                fetchAndRenderRelatedPosts(post);
                countView(post.id);
            } catch (err) {
                console.error("Gagal:", err);
                if (notFoundDiv) notFoundDiv.classList.remove('hidden');
            } finally {
                if (mainContent) mainContent.classList.remove('opacity-0');
            }
        }
        
        if(newsletterForm) newsletterForm.addEventListener('submit', handleNewsletter);
        initializePage();
    });
</script>
</body>
</html>

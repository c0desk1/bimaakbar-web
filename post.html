<!DOCTYPE html>
<html lang="id" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Bima Akbar</title>
    
    <meta name="apple-mobile-web-app-title" content="Bima Akbar" />
    <meta name="description" content=""> 
    <meta name="google-site-verification" content="tiYzo71ZJobcRYToMChdQ0bGyrGX1JdMK1zcr3EyaOQ" />
    
    <link rel="icon" type="image/png" href="admin/assets/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="admin/assets/favicon/favicon.svg" />
    <link rel="shortcut icon" href="admin/assets/favicon/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="admin/assets/favicon/apple-touch-icon.png" />
    <link rel="manifest" href="admin/assets/favicon/site.webmanifest" />
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    
    <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src='https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);})(window,document,'script','dataLayer','GTM-TJXJBGLX');</script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="admin/scripts/supabaseConfig.js"></script> 
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');
        @keyframes slide-in { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes pulse { 50% { opacity: .5; } }
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #a3a3a3; }
        .glass-header { background: rgba(10,10,10,0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border-bottom: 1px solid rgba(255,255,255,0.1); }
        .prose-styles h2, .prose-styles h3 { scroll-margin-top: 5rem; color: #fafafa; font-weight: 700; margin-top: 2em; margin-bottom: 1em; }
        .prose-styles p { line-height: 1.75; margin-bottom: 1.25em; }
        .prose-styles a { color: #818cf8; text-decoration: underline; }
        .prose-styles blockquote { border-left: 3px solid #6366f1; padding-left: 1.5rem; margin: 1.5rem 0; font-style: italic; color: #d4d4d8; }
        .prose-styles img { border-radius: 0.75rem; margin: 2rem 0; }
        .comment-card { background-color: rgba(23, 23, 23, 0.5); border: 1px solid rgba(255, 255, 255, 0.1); }
        .comment-form textarea { background-color: rgba(38, 38, 38, 0.8); border: 1px solid rgba(255,255,255,0.1); color: #e5e7eb; }
        .related-card:hover .related-img { transform: scale(1.05); }
        .ad-slot { display: flex; justify-content: center; align-items: center; }
        .ad-slot-2 { display: flex; justify-content: center; align-items: center; }
        .animate-slide-in { animation: slide-in 0.3s ease-out forwards; }
        .toast-message { background-color: rgba(23, 23, 23, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .skeleton-pulse { display: block; background-color: rgba(255, 255, 255, 0.1); border-radius: 0.25rem; animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }

    </style>    
</head>
<body class="antialiased">
    <noscript>
        <iframe src="https://www.googletagmanager.com/ns.html?id=GTM-TJXJBGLX"
            height="0"
            width="0"
            style="display:none;visibility:hidden">
        </iframe>
    </noscript>

    <header class="glass-header sticky top-0 z-50">
        <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="grid grid-cols-3 items-center h-16">
                <div class="justify-self-start"><a href="index.html" class="flex items-center space-x-2 text-gray-300 hover:text-white"><i class="ri-arrow-left-s-line text-xl"></i><span class="text-sm font-semibold hidden sm:block">Kembali</span></a></div>
                <div class="justify-self-center"><a href="index.html"><img src="admin/assets/logo.jpg" alt="Logo" class="h-8 w-auto"></a></div>
                <div class="justify-self-end"><button id="native-share-btn" title="Bagikan" class="text-gray-300 hover:text-white p-2 rounded-full hover:bg-white/10"><i class="ri-share-line text-xl"></i></button></div>
            </div>
        </div>
    </header>

    <main id="mainContent" class="opacity-0 transition-opacity duration-500">
        <div id="notFound" class="hidden text-center py-20">
             <h1 class="text-6xl font-black text-white">404</h1><p class="text-xl mt-4 text-gray-400">Postingan tidak ditemukan.</p>
            <a href="index.html" class="mt-8 inline-block bg-indigo-500 text-white font-semibold py-2 px-6 rounded-lg">Kembali ke Beranda</a>
        </div>
        <article class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-16">
            <div id="post-container"> <header class="mb-8">
                    <p id="post-category" class="font-semibold text-indigo-400 uppercase tracking-wider text-sm">
                        <span class="skeleton-pulse h-4 w-24 mb-1"></span>
                    </p>
                    <h1 id="post-title" class="text-3xl md:text-5xl font-extrabold text-white mt-2">
                        <span class="skeleton-pulse h-8 w-3/4 mb-2"></span>
                        <span class="skeleton-pulse h-8 w-1/2"></span>
                    </h1>
                    <div id="post-meta" class="mt-4 text-sm text-gray-400 flex items-center flex-wrap gap-x-4 gap-y-2">
                        <span class="skeleton-pulse h-4 w-32"></span>
                        <span class="skeleton-pulse h-4 w-24"></span>
                        <span class="skeleton-pulse h-4 w-28"></span>
                    </div>
                </header>
                <div class="ad-slot my-12 h-24 rounded-2xl">
                    <script type="text/javascript">
                        atOptions = { 'key' : '33abd0e9772a23eff62a88e951d12370', 'format' : 'iframe', 'height' : 90, 'width' : 728, 'params' : {} };
                    </script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/33abd0e9772a23eff62a88e951d12370/invoke.js"></script>
                </div>
                
                <script type="text/javascript" src="//www.highperformanceformat.com/33abd0e9772a23eff62a88e951d12370/invoke.js"></script>
                <div id="table-of-contents" class="my-8 p-6 glass-card rounded-2xl"> <h2 class="text-xl font-bold text-white mb-4 mt-0">Daftar Isi</h2>
                    <ul id="toc-list" class="space-y-2 list-disc list-inside text-indigo-300">
                        <li class="skeleton-pulse h-4 w-full"></li>
                        <li class="skeleton-pulse h-4 w-5/6"></li>
                        <li class="skeleton-pulse h-4 w-full ml-4"></li>
                        <li class="skeleton-pulse h-4 w-3/4"></li>
                    </ul>
                </div>
                <img id="post-thumbnail" src="" alt="" class="w-full rounded-2xl shadow-lg mb-8 bg-neutral-800 aspect-video object-cover"> <div id="post-content" class="prose-styles text-lg">
                    <p><span class="skeleton-pulse h-5 w-full mb-2"></span></p>
                    <p><span class="skeleton-pulse h-5 w-11/12 mb-2"></span></p>
                    <p><span class="skeleton-pulse h-5 w-full mb-2"></span></p>
                    <p><span class="skeleton-pulse h-5 w-2/3 mb-2"></span></p>
                    <h2 class="skeleton-pulse h-6 w-1/3 my-4"></h2>
                    <p><span class="skeleton-pulse h-5 w-full mb-2"></span></p>
                    <p><span class="skeleton-pulse h-5 w-full mb-2"></span></p>
                    <p><span class="skeleton-pulse h-5 w-4/5 mb-2"></span></p>
                </div>
            </div>
            
            <section id="comments-section" class="mt-16 pt-12 border-t border-white/10">
                <div class="my-12 ad-slot min-h-[250px] w-full max-w-[300px] mx-auto">
                    <script type="text/javascript">atOptions = {'key' : '2cbf81c154955340571b0538f45abe56','format' : 'iframe','height' : 250,'width' : 300,'params' : {}};</script>
                    <script type="text/javascript" src="//www.highperformanceformat.com/2cbf81c154955340571b0538f45abe56/invoke.js"></script>
                </div>
                <h2 class="text-2xl font-bold text-white mb-6">Komentar</h2>
                <div id="comment-form-container" class="mb-8">
                    <div class="space-y-3">
                        <div class="skeleton-pulse h-10 w-full"></div>
                        <div class="skeleton-pulse h-24 w-full"></div>
                        <div class="skeleton-pulse h-10 w-32 ml-auto"></div>
                    </div>
                </div>
                <div id="comments-list" class="space-y-6">
                    <div class="comment-card p-4 rounded-xl flex items-start gap-4">
                        <div class="w-10 h-10 rounded-full skeleton-pulse flex-shrink-0"></div>
                        <div class="flex-grow space-y-2">
                            <div class="skeleton-pulse h-4 w-1/3"></div>
                            <div class="skeleton-pulse h-4 w-full"></div>
                            <div class="skeleton-pulse h-4 w-2/3"></div>
                            <div class="skeleton-pulse h-3 w-1/4"></div>
                        </div>
                    </div>
                    <div class="comment-card p-4 rounded-xl flex items-start gap-4">
                        <div class="w-10 h-10 rounded-full skeleton-pulse flex-shrink-0"></div>
                        <div class="flex-grow space-y-2">
                            <div class="skeleton-pulse h-4 w-1/4"></div>
                            <div class="skeleton-pulse h-4 w-full"></div>
                            <div class="skeleton-pulse h-3 w-1/3"></div>
                        </div>
                    </div>
                </div>
            </section>
            <nav id="post-navigation" class="mt-16 pt-8 border-t border-white/10 flex justify-between gap-4">
                <div class="w-full skeleton-pulse h-16 mr-2"></div>
                <div class="w-full skeleton-pulse h-16 ml-2"></div>
            </nav>
            <section id="related-posts" class="mt-16 pt-12 border-t border-white/10">
                <h2 class="text-2xl font-bold text-white mb-6">Baca Juga</h2>
                <div id="related-posts-grid" class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <div class="block group">
                        <div class="overflow-hidden rounded-xl aspect-video skeleton-pulse"></div>
                        <h4 class="mt-3 font-semibold text-white group-hover:text-indigo-400 skeleton-pulse h-5 w-full"></h4>
                    </div>
                    <div class="block group">
                        <div class="overflow-hidden rounded-xl aspect-video skeleton-pulse"></div>
                        <h4 class="mt-3 font-semibold text-white group-hover:text-indigo-400 skeleton-pulse h-5 w-full"></h4>
                    </div>
                    <div class="block group hidden sm:block"> <div class="overflow-hidden rounded-xl aspect-video skeleton-pulse"></div>
                        <h4 class="mt-3 font-semibold text-white group-hover:text-indigo-400 skeleton-pulse h-5 w-full"></h4>
                    </div>
                </div>
            </section>
            <section id="newsletter" class="mt-16 pt-12 border-t border-white/10">
                <div class="bg-neutral-900/50 rounded-2xl p-8 text-center">
                    <h3 id="newsletter-title" class="text-2xl font-bold text-white"><span class="skeleton-pulse h-8 w-2/3 mx-auto"></span></h3>
                    <p id="newsletter-description" class="text-gray-400 mt-2 max-w-lg mx-auto"><span class="skeleton-pulse h-4 w-full"></span></p>
                    <form id="newsletterForm" class="mt-6 max-w-md mx-auto">
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input id="newsletterEmail" class="w-full px-4 py-3 rounded-lg bg-neutral-800 text-white border border-neutral-700 skeleton-pulse">
                            <button id="newsletterSubmitBtn" class="bg-indigo-500 text-white font-semibold py-3 px-6 rounded-lg hover:bg-indigo-600 skeleton-pulse"></button>
                        </div>
                        <p id="newsletterMessage" class="text-xs mt-2 h-4"></p>
                    </form>
                </div>
            </section>
        </article>
    </main>

    <footer class="text-center py-12 border-t border-white/10 mt-20">
        <p class="text-sm text-gray-500">&copy; 2025 Bima Akbar. All Rights Reserved.</p>
    </footer>
    <button id="back-to-top" class="hidden fixed bottom-6 right-6 bg-indigo-500 text-white w-12 h-12 rounded-full shadow-lg hover:bg-indigo-600 transition-all z-50 justify-center items-center"><i class="ri-arrow-up-s-line text-2xl"></i></button>
    
    <div id="toast-container" class="fixed top-8 right-8 space-y-3 z-50"></div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
            const mainContent = document.getElementById('mainContent');
            const postContainer = document.getElementById('post-container');
            const notFoundDiv = document.getElementById('notFound');
            const commentsSection = document.getElementById('comments-section');
            const commentFormContainer = document.getElementById('comment-form-container');
            const newsletterSection = document.getElementById('newsletter');
            const postNavigation = document.getElementById('post-navigation');
            const relatedPosts = document.getElementById('related-posts');
            const newsletterForm = document.getElementById('newsletterForm');
            const backToTopBtn = document.getElementById('back-to-top');
            const newsletterTitle = document.getElementById('newsletter-title');
            const newsletterDescription = document.getElementById('newsletter-description');
            const newsletterEmailInput = document.getElementById('newsletterEmail');
            const newsletterSubmitBtn = document.getElementById('newsletterSubmitBtn');

            function clearNewsletterSkeleton() {
            // Isi teks asli dan hapus skeleton span
            if (newsletterTitle) newsletterTitle.innerHTML = 'Suka dengan Tulisan Ini?';
            if (newsletterDescription) newsletterDescription.innerHTML = 'Dapatkan notifikasi setiap kali ada konten baru.';
            
            // Atur atribut untuk input dan button
            if (newsletterEmailInput) {
                newsletterEmailInput.setAttribute('type', 'email');
                newsletterEmailInput.setAttribute('placeholder', 'Masukkan email Anda');
                newsletterEmailInput.setAttribute('required', '');
                newsletterEmailInput.classList.remove('skeleton-pulse');
            }
            if (newsletterSubmitBtn) {
                newsletterSubmitBtn.setAttribute('type', 'submit');
                newsletterSubmitBtn.textContent = 'Daftar';
                newsletterSubmitBtn.classList.remove('skeleton-pulse');
            }
        }
        
            // === FUNGSI showToast (Untuk feedback UI) ===
            async function showToast(message, type = 'success', errorObject = null) {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    console.warn("Toast container not found. Messages will only appear in console.");
                    console.log(`Toast: ${type.toUpperCase()} - ${message}`, errorObject);
                    return;
                }
        
                const toast = document.createElement('div');
                const icon = type === 'success' ? '<i class="ri-checkbox-circle-fill"></i>' : '<i class="ri-error-warning-fill"></i>';
            
                toast.className = `flex items-center space-x-3 text-white text-sm font-semibold p-3 rounded-xl shadow-lg toast-message transition-all duration-300 transform translate-x-full animate-slide-in`;
                toast.style.backgroundColor = type === 'success' ? 'rgba(34, 197, 94, 0.8)' : 'rgba(239, 68, 68, 0.8)';
                toast.innerHTML = `<span>${icon}</span><p>${message}</p>`;
                toastContainer.appendChild(toast);
            
                if (type === 'error' && errorObject) {
                    console.error("Mencatat error ke database:", errorObject);
                    supabase.from('error_logs').insert({
                        error_message: errorObject.message,
                        error_details: { code: errorObject.code, details: errorObject.details, hint: errorObject.hint },
                        location: "Client-Side Post Viewer",
                        user_id: null,
                        user_email: null
                    }).then(() => console.log('Error logged.'));
                }
            
                setTimeout(() => {
                    toast.classList.remove('animate-slide-in');
                    toast.classList.add('opacity-0');
                }, 4000);
                setTimeout(() => {
                    toast.remove();
                }, 4000 + 350);
            }
        
            if (backToTopBtn) {
                window.onscroll = () => {
                    if (document.body.scrollTop > 200 || document.documentElement.scrollTop > 200) {
                        backToTopBtn.style.display = "flex";
                    } else {
                        backToTopBtn.style.display = "none";
                    }
                };
                backToTopBtn.addEventListener('click', () => {
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                });
            }
        
            function updateSeoMeta(post) {
                const finalTitle = post.meta_title || post.title || "Bima Akbar";
                document.title = finalTitle;
                setMetaTag('og:title', finalTitle, 'property');
        
                const finalDescription = post.meta_description || '';
                setMetaTag('description', finalDescription, 'name');
                setMetaTag('og:description', finalDescription, 'property');
        
                const finalOgUrl = post.og_url || `${window.location.origin}/post.html?slug=${post.slug}`;
                setMetaTag('og:url', finalOgUrl, 'property');
                setLinkRel('canonical', finalOgUrl);
        
                const finalOgImage = post.og_image_url || post.thumbnail_url || `${window.location.origin}/assets/logo.jpg`;
                setMetaTag('og:image', finalOgImage, 'property');
        
                setMetaTag('og:type', post.og_type || 'article', 'property');
        
                setMetaTag('keywords', post.keywords || '', 'name');
                
                setMetaTag('twitter:card', 'summary_large_image', 'name');
                setMetaTag('twitter:title', finalTitle, 'name');
                setMetaTag('twitter:description', finalDescription, 'name');
                setMetaTag('twitter:image', finalOgImage, 'name');
            }
        
            function setMetaTag(propertyOrName, content, attrType) {
                let element = document.querySelector(`meta[${attrType}="${propertyOrName}"]`);
                if (!element) {
                    element = document.createElement('meta');
                    element.setAttribute(attrType, propertyOrName);
                    document.head.appendChild(element);
                }
                element.setAttribute('content', content);
            }
        
            function setLinkRel(rel, href) {
                let element = document.querySelector(`link[rel="${rel}"]`);
                if (!element) {
                    element = document.createElement('link');
                    element.setAttribute('rel', rel);
                    document.head.appendChild(element);
                }
                element.setAttribute('href', href);
            }
        
            function displayPost(post) {
                document.getElementById('post-category').innerHTML = post.category || '';
                document.getElementById('post-title').innerHTML = post.title;
                const postMeta = document.getElementById('post-meta');
                postMeta.innerHTML = `<span>Oleh ${post.author || 'Anonim'}</span><span>•</span><span>${new Date(post.created_at).toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'})}</span><span>•</span><span class="flex items-center"><i class="ri-eye-line mr-1"></i>${post.views || 0} views</span>`;
                
                const thumbnail = document.getElementById('post-thumbnail');
                if (post.thumbnail_url) {
                    thumbnail.src = post.thumbnail_url;
                    thumbnail.alt = post.title;
                    thumbnail.style.display = 'block';
                } else {
                    thumbnail.style.display = 'none';
                }
        
                const contentEl = document.getElementById('post-content');
                contentEl.innerHTML = post.content;
                return contentEl;
            }
        
            function setupShareButton(postTitle) {
                const shareBtn = document.getElementById('native-share-btn');
                if (!shareBtn) return;
                shareBtn.addEventListener('click', async () => {
                    const shareData = { title: postTitle, text: `Cek artikel menarik: ${postTitle}`, url: window.location.href };
                    try {
                        if (navigator.share) await navigator.share(shareData);
                        else throw new Error('Web Share tidak didukung. Menggunakan fallback clipboard.');
                    } catch (err) {
                        if (err.name !== 'AbortError') { 
                            navigator.clipboard.writeText(window.location.href)
                                .then(() => showToast('Link artikel berhasil disalin!', 'success'))
                                .catch(clipErr => showToast('Gagal menyalin link: ' + clipErr.message, 'error', clipErr));
                        }
                    }
                });
            }
        
            function calculateReadTime(contentElement) {
                if (!contentElement) return '';
                const text = contentElement.textContent || '';
                const wordCount = text.split(/\s+/).filter(Boolean).length;
                const wpm = 225;
                const minutes = Math.ceil(wordCount / wpm);
                return `<span>•</span><span>☕️ ${minutes} menit baca</span>`;
            }
        
            function generateTableOfContents(contentElement) {
                const tocContainer = document.getElementById('table-of-contents');
                const tocList = document.getElementById('toc-list');
                if (!tocContainer || !tocList || !contentElement) return;
                const headings = contentElement.querySelectorAll('h2, h3');
                
                tocList.innerHTML = ''; 
        
                if (headings.length < 2) {
                    tocContainer.style.display = 'none';
                    return;
                }
                
                headings.forEach((heading, index) => {
                    const id = `heading-${index}`;
                    heading.id = id;
                    const listItem = document.createElement('li');
                    if (heading.tagName === 'H3') listItem.classList.add('ml-4');
                    listItem.innerHTML = `<a href="#${id}" class="hover:text-white">${heading.textContent}</a>`;
                    tocList.appendChild(listItem);
                });
                tocContainer.style.display = 'block';
            }
        
            async function fetchPrevNextPosts(currentPost) {
                const navContainer = document.getElementById('post-navigation');
                if (!navContainer) return;
        
                navContainer.innerHTML = ''; 
        
                const currentTimestamp = new Date(currentPost.created_at).toISOString();
        
                const [prevPostRes, nextPostRes] = await Promise.all([
                    supabase.from('posts').select('title,slug').eq('published', true).lt('created_at', currentTimestamp).order('created_at', { ascending: false }).limit(1),
                    supabase.from('posts').select('title,slug').eq('published', true).gt('created_at', currentTimestamp).order('created_at', { ascending: true }).limit(1)
                ]);
        
                const prevPost = prevPostRes.data && prevPostRes.data.length > 0 ? prevPostRes.data[0] : null;
                const nextPost = nextPostRes.data && nextPostRes.data.length > 0 ? nextPostRes.data[0] : null;
                
                let prevHTML = `<a href="index.html" class="text-left"><p class="text-sm text-gray-400">Semua Post</p><p class="font-semibold text-white hover:text-indigo-400"><i class="ri-apps-2-line mr-2"></i>Beranda</p></a>`;
                if (prevPost) {
                    prevHTML = `<a href="post.html?slug=${prevPost.slug}" class="text-left"><p class="text-sm text-gray-400">Sebelumnya</p><p class="font-semibold text-white hover:text-indigo-400">${prevPost.title}</p></a>`;
                }
        
                let nextHTML = `<a href="index.html" class="text-right"><p class="text-sm text-gray-400">Semua Post</p><p class="font-semibold text-white hover:text-indigo-400">Beranda<i class="ri-apps-2-line ml-2"></i></p></a>`;
                if (nextPost) {
                    nextHTML = `<a href="post.html?slug=${nextPost.slug}" class="text-right"><p class="text-sm text-gray-400">Berikutnya</p><p class="font-semibold text-white hover:text-indigo-400">${nextPost.title}</p></a>`;
                }
                
                navContainer.innerHTML = prevHTML + nextHTML;
            }
        
            async function fetchAndRenderRelatedPosts(currentPost) {
                const relatedContainer = document.getElementById('related-posts');
                const relatedGrid = document.getElementById('related-posts-grid');
                if (!relatedContainer || !relatedGrid || !currentPost.category) {
                    relatedContainer.style.display = 'none';
                    return;
                }
                
                relatedGrid.innerHTML = '';
        
                const { data, error } = await supabase.from('posts').select('title, slug, thumbnail_url').eq('published', true).eq('category', currentPost.category).neq('id', currentPost.id).limit(3);
                if (data && data.length > 0) {
                    relatedContainer.style.display = 'block';
                    data.forEach(post => {
                        relatedGrid.innerHTML += `<a href="post.html?slug=${post.slug}" class="block group"><div class="overflow-hidden rounded-xl aspect-video bg-neutral-800"><img src="${post.thumbnail_url}" alt="${post.title}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105"></div><h4 class="mt-3 font-semibold text-white group-hover:text-indigo-400">${post.title}</h4></a>`;
                    });
                } else {
                    relatedContainer.style.display = 'none';
                }
            }
        
            async function fetchAndRenderComments(postId) {
                const commentsList = document.getElementById('comments-list');
                if (!commentsList) return;
                commentsList.innerHTML = `<p class="text-slate-400 text-sm">Memuat komentar...</p>`;
                
                const { data, error } = await supabase.from('comments').select('*').eq('post_id', postId).eq('is_approved', true).order('created_at', { ascending: true });
                if (error || !data) { showToast('Gagal memuat komentar.', 'error', error); commentsList.innerHTML = '<p class="text-red-400">Gagal memuat komentar.</p>'; return; }
                if (data.length === 0) { commentsList.innerHTML = '<p class="text-slate-400 text-sm">Jadilah yang pertama berkomentar!</p>'; return; }
                
                commentsList.innerHTML = '';
                data.forEach(comment => {
                    commentsList.innerHTML += `<div class="comment-card p-4 rounded-xl flex items-start gap-4"><div class="w-10 h-10 rounded-full bg-indigo-500 flex-shrink-0 flex items-center justify-center font-bold text-white text-lg">${comment.author_name.charAt(0).toUpperCase()}</div><div><p class="font-semibold text-white">${comment.author_name}</p><p class="text-sm text-slate-300 mt-1">${comment.content}</p><p class="text-xs text-slate-500 mt-2">${new Date(comment.created_at).toLocaleString('id-ID')}</p></div></div>`;
                });
            }
            
            function renderCommentForm(postId, session) {
                commentFormContainer.innerHTML = ''; 
        
                let formHTML = '';
                if (session) {
                    formHTML = `
                        <form id="comment-form" data-post-id="${postId}" class="comment-form space-y-3">
                            <p class="text-sm text-slate-400">Anda berkomentar sebagai <span class="font-semibold text-white">${session.user.email.split('@')[0]}</span>.</p>
                            <textarea name="content" required class="w-full p-3 rounded-lg h-24 bg-neutral-800 text-white border border-neutral-700" placeholder="Tulis komentarmu di sini..."></textarea>
                            <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-600">Kirim Komentar</button>
                        </form>
                    `;
                } else {
                    formHTML = `
                        <form id="comment-form" data-post-id="${postId}" class="comment-form space-y-4">
                            <p class="text-sm text-slate-400">Email Anda tidak akan dipublikasikan.</p>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input name="author_name" required class="form-input w-full p-2.5 bg-neutral-800 rounded-lg" placeholder="Nama (wajib)">
                                <input name="author_email" type="email" required class="form-input w-full p-2.5 bg-neutral-800 rounded-lg" placeholder="Email (wajib)">
                            </div>
                            <textarea name="content" required class="w-full p-3 rounded-lg h-24 bg-neutral-800 text-white border border-neutral-700" placeholder="Tulis komentarmu di sini..."></textarea>
                            <button type="submit" class="bg-indigo-500 text-white font-semibold py-2 px-5 rounded-lg hover:bg-indigo-600">Kirim Komentar</button>
                        </form>
                    `;
                }
                commentFormContainer.innerHTML = formHTML;
            }
            
            commentFormContainer.addEventListener('submit', async (e) => {
                if (e.target.id !== 'comment-form') return;
                e.preventDefault();
                
                const form = e.target;
                const content = form.content.value.trim();
                const button = form.querySelector('button');
                const postId = form.dataset.postId;
        
                if (!content) { showToast('Isi komentar tidak boleh kosong.', 'error'); return; }
                button.disabled = true;
                button.textContent = 'Mengirim...';
        
                const { data: { session } } = await supabase.auth.getSession();
                
                let commentData = {};
        
                if (session) {
                    commentData = {
                        post_id: postId,
                        author_name: session.user.email.split('@')[0],
                        content: content,
                        user_id: session.user.id
                    };
                } else {
                    const guestName = form.author_name.value.trim();
                    const guestEmail = form.author_email.value.trim();
                    if (!guestName || !guestEmail) {
                        showToast("Nama dan Email wajib diisi.", 'error');
                        button.disabled = false; button.textContent = 'Kirim Komentar';
                        return;
                    }
                    commentData = {
                        post_id: postId,
                        author_name: guestName,
                        author_email: guestEmail,
                        content: content
                    };
                }
                
                const { error } = await supabase.from('comments').insert(commentData);
        
                if (error) {
                    showToast('Gagal mengirim komentar: ' + error.message, 'error', error);
                } else {
                    showToast('Komentar berhasil dikirim dan sedang menunggu moderasi. Terima kasih!');
                    form.reset();
                    fetchAndRenderComments(postId);
                }
                button.disabled = false;
                button.textContent = 'Kirim Komentar';
            });
        
            async function countView(postId) {
                try { await supabase.functions.invoke('increment-post-view', { body: { post_id: postId } }); } 
                catch (error) { console.error("Gagal menghitung view:", error); /* showToast juga bisa jika mau notif ke user */ }
            }
        
            async function handleNewsletter(e) {
                e.preventDefault();
                const emailInput = document.getElementById('newsletterEmail');
                const messageEl = document.getElementById('newsletterMessage');
                if (!emailInput || !messageEl) return;
                const email = emailInput.value.trim();
                if (!email) {
                    showToast('Email tidak boleh kosong.', 'error');
                    return;
                }
                messageEl.textContent = 'Memproses...';
                messageEl.className = 'text-xs mt-2 h-4 text-amber-400';
                const { error } = await supabase.from('subscribers').insert({ email: email });
                if (error) {
                    if (error.code === '23505') {
                        showToast('Email ini sudah terdaftar!', 'info');
                        messageEl.textContent = 'Email ini sudah terdaftar!';
                        messageEl.className = `text-xs mt-2 h-4 text-green-400`;
                    } else {
                        showToast('Gagal mendaftar newsletter: ' + error.message, 'error', error);
                        messageEl.textContent = 'Gagal mendaftar.';
                        messageEl.className = `text-xs mt-2 h-4 text-red-400`;
                    }
                } else {
                    showToast('Terima kasih telah mendaftar newsletter!');
                    messageEl.textContent = 'Terima kasih telah mendaftar!';
                    messageEl.className = 'text-xs mt-2 h-4 text-green-400';
                    emailInput.value = '';
                }
            }
        
            async function initializePage() {
                try {
                    const slug = new URLSearchParams(window.location.search).get('slug');
                    if (!slug) throw new Error("Slug tidak ditemukan di URL.");
        
                    // ==== INISIALISASI SKELETON LOADING ====
                    // Pastikan semua elemen yang akan diisi data memiliki skeleton di HTML
                    // dan akan di-clear/replace saat data dimuat.
                    // mainContent.classList.remove('opacity-0'); // Ini bisa dihapus jika Anda ingin skeleton langsung terlihat
        
                    const { data: post, error } = await supabase.from('posts').select('*').eq('slug', slug).eq('published', true).single();
                    if (error || !post) throw new Error("Postingan tidak ditemukan atau belum dipublikasikan."); 

                    postContainer.style.display = 'block';
        
                    updateSeoMeta(post);
                    const contentEl = displayPost(post);
                    setupShareButton(post.title);
                    
                    const postMeta = document.getElementById('post-meta');
                    if (postMeta) postMeta.innerHTML += calculateReadTime(contentEl);
                    
                    generateTableOfContents(contentEl);
                    
                    const { data: { session } } = await supabase.auth.getSession();
                    renderCommentForm(post.id, session);
                    
                    fetchAndRenderComments(post.id);
                    fetchPrevNextPosts(post);
                    fetchAndRenderRelatedPosts(post);
                    countView(post.id);
                    clearNewsletterSkeleton();
        
                } catch (err) {
                    console.error("Gagal menginisialisasi halaman:", err);
                    if (notFoundDiv) {
                        notFoundDiv.classList.remove('hidden');
                        const p = notFoundDiv.querySelector('p');
                        if (p) p.textContent = err.message;
                        showToast(`Gagal memuat postingan: ${err.message}`, 'error', err);
                    }
                    // Sembunyikan semua konten jika ada error dan tampilkan notFoundDiv
                    postContainer.style.display = 'none'; 
                    commentsSection.style.display = 'none';
                    postNavigation.style.display = 'none';
                    relatedPosts.style.display = 'none';
                    newsletterSection.style.display = 'none';
        
                } finally {
                    if (mainContent) mainContent.classList.remove('opacity-0');
                }
            }
            
            if (newsletterForm) newsletterForm.addEventListener('submit', handleNewsletter);
            initializePage();
        });
        </script>
    </body>
</html>

<!DOCTYPE html>
<html lang="id" data-bs-theme="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Tambah Postingan</title>
  <link rel="icon" href="assets/favicon.ico"> 
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>  
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
 
  <style>
    /* Variabel CSS Kustom untuk tema Dark Modern */
    :root {
      --bs-body-bg: #1A1A1A; /* Background utama yang lebih gelap */
      --bs-body-color: #E0E0E0; /* Warna teks utama lebih lembut */
      --bs-secondary-color: #B0B0B0; /* Warna teks sekunder/deskripsi */
      --bs-border-color: #333333; /* Warna border yang lebih tegas tapi tetap gelap */
      --bs-emphasis-color: #007AFF; /* Aksen biru yang lebih cerah, cocok untuk glow */
      --bs-light-rgb: 45,45,45; /* Untuk background card/input yang sedikit lebih terang dari body */

      /* Overrides for Bootstrap dark theme internals */
      --bs-body-bg-rgb: 26,26,26;
      --bs-border-color-rgb: 51,51,51;
      --bs-heading-color: #F2F2F7;
      --bs-link-color: var(--bs-emphasis-color);
      --bs-link-hover-color: var(--bs-emphasis-color);

      /* Form control specific overrides for dark theme */
      --bs-form-control-bg: #282828; /* Warna background input/select */
      --bs-form-color: #E0E0E0;
      --bs-form-control-border-color: #444444; /* Border input sedikit lebih terang */
      --bs-form-control-placeholder-color: #8A8A8A; /* Warna placeholder */
      --bs-form-control-focus-border-color: rgba(0, 122, 255, 0.5); /* Fokus border color */
      --bs-form-control-focus-box-shadow: 0 0 0 0.25rem rgba(0, 122, 255, 0.25); /* Fokus shadow */


      /* Custom toolbar background color */
      --toolbar-bg-color: #222222;

      /* Tooltip Custom Styles */
      --bs-tooltip-bg: #333333;
      --bs-tooltip-color: #F2F2F7;
      --bs-tooltip-opacity: 0.95;
    }

    body {
      padding-bottom: 80px;
    }

    .form-text {
      color: var(--bs-secondary-color) !important;
      font-size: 0.875rem;
    }

    /* Editor Specific Styles - Perbaikan Layout */
    .editor-wrapper {
        background-color: var(--bs-form-control-bg);
        border: 1px solid var(--bs-form-control-border-color);
        border-radius: var(--bs-border-radius-lg);
        overflow: hidden; 
        display: flex; 
        flex-direction: column; 
        min-height: 350px; 
    }
    #editor {
      flex-grow: 1; 
      min-height: 250px; 
      width: 100%;
      outline: none;
      font-size: 1rem;
      line-height: 1.6;
      color: var(--bs-form-color);
      background-color: var(--bs-form-control-bg);
      padding: 1rem;
      overflow-y: auto; 
    }
    #editor:empty:before {
      content: attr(data-placeholder);
      color: var(--bs-form-control-placeholder-color);
      font-style: italic;
    }
    .toolbar {
      flex-shrink: 0; 
      display: flex !important; 
      flex-wrap: wrap;
      justify-content: flex-start;
      gap: 0.5rem;
      background-color: var(--toolbar-bg-color); 
      border-top: 1px solid var(--bs-form-control-border-color);
      padding: 0.8rem 1rem;
      border-bottom-left-radius: var(--bs-border-radius-lg);
      border-bottom-right-radius: var(--bs-border-radius-lg);
      box-shadow: 0 -2px 5px rgba(0, 0, 0, 0.2); 
      z-index: 2;
    }
    .toolbar button {
      background: none;
      border: none;
      color: var(--bs-body-color);
      padding: 0.6rem;
      border-radius: var(--bs-border-radius-sm);
      transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
    }
    .toolbar button:hover {
        background-color: rgba(var(--bs-light-rgb), 0.5);
    }
    .toolbar button:active,
    .toolbar button:focus {
      color: var(--bs-emphasis-color);
      background-color: rgba(0, 122, 255, 0.3);
      box-shadow: 0 0 0 0.25rem rgba(0, 122, 255, 0.35);
      outline: none;
    }

    /* Gaya untuk ikon Bootstrap */
    .toolbar button .bi {
        font-size: 20px;
        color: var(--bs-body-color);
    }

    /* Ubah warna ikon saat tombol di-hover/active/focus */
    .toolbar button:hover .bi {
        color: var(--bs-body-color);
    }
    .toolbar button:active .bi,
    .toolbar button:focus .bi {
        color: var(--bs-emphasis-color);
    }

    /* Dropdown Toggle Kustom untuk Toolbar - Dibuat konsisten dengan tombol lain */
    .toolbar .dropdown-toggle {
        padding: 0.6rem;
        background-color: transparent;
        border: none;
        color: var(--bs-body-color) !important;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        transition: background-color 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
        border-radius: var(--bs-border-radius-sm);
    }
    .toolbar .dropdown-toggle:hover {
        background-color: rgba(var(--bs-light-rgb), 0.5);
    }
    .toolbar .dropdown-toggle:active,
    .toolbar .dropdown-toggle:focus {
        color: var(--bs-emphasis-color);
        background-color: rgba(0, 122, 255, 0.3);
        box-shadow: 0 0 0 0.25rem rgba(0, 122, 255, 0.35);
        outline: none;
    }
    /* Khusus untuk dropdown toggle yang hanya ikon */
    .toolbar .dropdown-toggle.icon-only::after {
        margin-left: 0.25em;
        vertical-align: middle;
        font-size: 0.75rem;
    }
    /* Untuk ikon pada dropdown item */
    .dropdown-item .bi {
        font-size: 1rem;
        margin-right: 0.5rem;
    }
    /* Untuk spinner saat upload gambar */
    .toolbar button .spinner-border {
        margin-right: 0.5rem;
    }

    /* Gaya untuk form-control dan form-select */
    .form-control,
    .form-select {
        background-color: var(--bs-form-control-bg);
        color: var(--bs-form-color);
        border: 1px solid var(--bs-form-control-border-color);
        border-radius: var(--bs-border-radius);
        transition: border-color .15s ease-in-out, box-shadow .15s ease-in-out;
    }
    .form-control::placeholder {
        color: var(--bs-form-control-placeholder-color);
        opacity: 1;
    }
    .form-control:focus,
    .form-select:focus {
        background-color: var(--bs-form-control-bg);
        color: var(--bs-form-color);
        border-color: var(--bs-form-control-focus-border-color);
        box-shadow: var(--bs-form-control-focus-box-shadow);
        outline: 0;
    }

    /* Custom arrow for form-select in dark theme */
    .form-select {
        /* Filter SVG to light grey/white for dark theme (E0E0E0 is a light grey) */
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16'%3e%3cpath fill='none' stroke='%23E0E0E0' stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='m2 5 6 6 6-6'/%3e%3c/svg%3e");
        background-repeat: no-repeat;
        /* Position it correctly: 0.75rem from right, centered vertically */
        background-position: right 0.75rem center; 
        background-size: 1rem;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
        padding-right: 2.25rem;
    }

    /* Style for options within the select dropdown */
    .form-select option {
        background-color: var(--bs-form-control-bg);
        color: var(--bs-form-color);
        /* Ini adalah untuk style opsi saat dropdown TERBUKA. Browser sering membatasi styling ini. */
    }


    .header-bar {
      position: sticky;
      top: 0;
      z-index: 10;
      background-color: rgba(26, 26, 26, 0.9);
      backdrop-filter: blur(8px);
      padding: 1rem 1.5rem;
      border-bottom: 1px solid var(--bs-border-color);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-bar .btn-back {
            color: var(--bs-emphasis-color);
            padding: 0.5rem;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease, opacity 0.2s ease;
        }
        .header-bar .btn-back svg {
            width: 24px;
            height: 24px;
            fill: currentColor;
        }
        .header-bar .btn-back:hover {
            background-color: rgba(var(--bs-emphasis-color-rgb), 0.1);
            opacity: 0.9;
        }
        
    .header-bar h6 {
        flex-grow: 1;
        text-align: center;
        margin-bottom: 0;
        font-weight: 600;
        color: var(--bs-heading-color);
    }
    /* Gaya untuk tombol preview */
    .header-bar .btn-preview {
        z-index: 11;
        margin-left: auto;
    }

    .error-message { 
        color: var(--bs-danger);
        font-size: 0.875rem; 
        margin-top: 0.25rem; 
    }
    #thumbnailPreview {
        max-width: 200px; 
        max-height: 150px; 
        margin-top: 10px; 
        display: none;
        object-fit: contain;
        border-radius: var(--bs-border-radius-sm);
    }
    /* Custom style for primary button (Save & Post) */
    .btn-primary {
        background-color: var(--bs-emphasis-color);
        border-color: var(--bs-emphasis-color);
        box-shadow: 0 0 0 0 rgba(0, 122, 255, 0);
        transition: background-color 0.2s ease, border-color 0.2s ease, box-shadow 0.2s ease;
    }
    .btn-primary:hover {
        background-color: #006EDC;
        border-color: #006EDC;
    }
    .btn-primary:focus {
        background-color: #006EDC;
        border-color: #006EDC;
        box-shadow: 0 0 0 0.25rem rgba(0, 122, 255, 0.25);
    }
    .btn-primary.text-white {
        color: white !important;
    }

    /* Custom Tooltip Styles for Dark Theme (Apple-like) */
	.tooltip-inner {
	  background-color: rgba(55, 55, 55, 0.95); /* Hampir opaque, mirip dengan SF Popover background */
	  color: #F2F2F7;
	  opacity: 1; 
	  padding: 0.65rem 1rem; 
	  border-radius: 0.6rem;
	  font-size: 0.8rem;
	  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4); 
	}
	
	.tooltip.bs-tooltip-top .tooltip-arrow::before {
	  border-top-color: rgba(55, 55, 55, 0.95); 
	}
	.tooltip.bs-tooltip-bottom .tooltip-arrow::before {
	  border-bottom-color: rgba(55, 55, 55, 0.95);
	}
	.tooltip.bs-tooltip-start .tooltip-arrow::before {
	  border-left-color: rgba(55, 55, 55, 0.95);
	}
	.tooltip.bs-tooltip-end .tooltip-arrow::before {
	  border-right-color: rgba(55, 55, 55, 0.95);
	}

  </style>
</head>
<body>
	<div class="header-bar">
		<a href="dashboard.html" class="btn-back">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor">
                <path fill-rule="evenodd" d="M11.03 3.97a.75.75 0 0 1 0 1.06l-6.22 6.22H21a.75.75 0 0 1 0 1.5H4.81l6.22 6.22a.75.75 0 1 1-1.06 1.06l-7.5-7.5a.75.75 0 0 1 0-1.06l7.5-7.5a.75.75 0 0 1 1.06 0Z" clip-rule="evenodd" />
            </svg>
        </a>
		<h6>Tambah Postingan</h6>
        <button type="button" class="btn btn-outline-primary rounded-pill btn-sm btn-preview" onclick="openPreview()" data-bs-toggle="tooltip" data-bs-placement="bottom" title="Pratinjau Postingan">
            <i class="bi bi-eye"></i>
        </button>
	</div>
	<div class="container py-4">
		<section class="py-4 mb-4 border-bottom">
			<div class="row align-items-center">
				<div class="col-md-8">
					<h1 class="h3 mb-1">Buat Postingan Baru</h1>
					<p class="mb-0 text-secondary">Mulai tulis ide dan bagikan cerita Anda.</p>
				</div>
			</div>
		</section>		
		<form id="postForm">
			<div class="mb-3">
	        	<label for="judul" class="form-label">Judul</label>
	        	<input type="text" class="form-control" id="judul" placeholder="Judul artikel" required />
	        	<div class="error-message" id="judulError"></div>
	     	</div>
      <div class="mb-3">
        <label for="kategori" class="form-label">Kategori</label>
        <select class="form-select" id="kategori" required>
          <option value="" disabled selected>Memuat...</option>
        </select>
        <div class="error-message" id="kategoriError"></div>
      </div>
      <div class="mb-3">
        <label for="tag" class="form-label">Tag</label>
        <input type="text" class="form-control" id="tag" placeholder="Contoh: UI, desain, lagu" />
        <div class="form-text">Pisahkan tag dengan koma.</div>
      </div>
      <div class="mb-3">
        <label for="thumbnail" class="form-label">Gambar Utama</label>
        <input type="file" class="form-control" id="thumbnail" accept="image/jpeg, image/png, image/jpg, image/webp" />
        <div class="form-text">Untuk thumbnail postingan. Format: JPG, PNG, WEBP. Maks. 2MB.</div>
        <div class="error-message" id="thumbnailError"></div>
        <img id="thumbnailPreview" src="" alt="Thumbnail Preview">
      </div>      
      <div class="mb-3">
        <label for="editor" class="form-label">Konten</label>
        <div class="editor-wrapper">
            <div id="editor" contenteditable="true" data-placeholder="Mulai tulis postingan Anda di sini..."></div>
            <div class="toolbar">
                <div class="dropdown">
                    <button class="dropdown-toggle icon-only" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" data-bs-placement="top" title="Pilih Heading">
                        <i id="currentHeadingIcon" class="bi bi-type-h2"></i> 
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H1', 'bi-type-h1')"><i class="bi bi-type-h1"></i> Heading 1</a></li>
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H2', 'bi-type-h2')"><i class="bi bi-type-h2"></i> Heading 2</a></li>
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H3', 'bi-type-h3')"><i class="bi bi-type-h3"></i> Heading 3</a></li>
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H4', 'bi-type-h4')"><i class="bi bi-type-h4"></i> Heading 4</a></li>
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H5', 'bi-type-h5')"><i class="bi bi-type-h5"></i> Heading 5</a></li>
                        <li><a class="dropdown-item" href="#" onclick="formatHeading('H6', 'bi-type-h6')"><i class="bi bi-type-h6"></i> Heading 6</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item" href="#" onclick="formatParagraph('bi-paragraph')"><i class="bi bi-paragraph"></i> Paragraf</a></li>
                    </ul>
                </div>
                <div class="dropdown">
                    <button class="dropdown-toggle icon-only" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-toggle="tooltip" data-bs-placement="top" title="Rata Teks">
                        <i id="currentAlignmentIcon" class="bi bi-text-left"></i> 
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#" onclick="alignText('justifyLeft', 'bi-text-left')"><i class="bi bi-text-left"></i> Rata Kiri</a></li>
                        <li><a class="dropdown-item" href="#" onclick="alignText('justifyCenter', 'bi-text-center')"><i class="bi bi-text-center"></i> Tengah</a></li>
                        <li><a class="dropdown-item" href="#" onclick="alignText('justifyRight', 'bi-text-right')"><i class="bi bi-text-right"></i> Rata Kanan</a></li>
                        </ul>
                </div>

                <button type="button" onclick="document.execCommand('bold')" data-bs-toggle="tooltip" data-bs-placement="top" title="Tebal"><i class="bi bi-type-bold"></i></button>
                <button type="button" onclick="document.execCommand('italic')" data-bs-toggle="tooltip" data-bs-placement="top" title="Miring"><i class="bi bi-type-italic"></i></button>
                <button type="button" onclick="document.execCommand('underline')" data-bs-toggle="tooltip" data-bs-placement="top" title="Garis Bawah"><i class="bi bi-type-underline"></i></button>
                
                <button type="button" onclick="tambahLink()" data-bs-toggle="tooltip" data-bs-placement="top" title="Tambah Link"><i class="bi bi-link-45deg"></i></button>
                <button type="button" onclick="triggerImageUpload()" data-bs-toggle="tooltip" data-bs-placement="top" title="Tambah Gambar"><i class="bi bi-image"></i></button>
                <input type="file" id="imageUploadInput" style="display: none;" accept="image/jpeg, image/png, image/jpg, image/gif, image/webp">

                <button type="button" onclick="document.execCommand('insertUnorderedList')" data-bs-toggle="tooltip" data-bs-placement="top" title="Daftar Tak Berurutan"><i class="bi bi-list-ul"></i></button>
                <button type="button" onclick="document.execCommand('insertOrderedList')" data-bs-toggle="tooltip" data-bs-placement="top" title="Daftar Berurutan"><i class="bi bi-list-ol"></i></button>
                <button type="button" onclick="document.execCommand('formatBlock', false, 'blockquote')" data-bs-toggle="tooltip" data-bs-placement="top" title="Blok Kutipan"><i class="bi bi-blockquote-left"></i></button>
                <button type="button" onclick="document.execCommand('formatBlock', false, 'pre')" data-bs-toggle="tooltip" data-bs-placement="top" title="Blok Kode"><i class="bi bi-code-slash"></i></button>
                
                <button type="button" onclick="document.execCommand('removeFormat')" data-bs-toggle="tooltip" data-bs-placement="top" title="Hapus Format"><i class="bi bi-x-circle"></i></button>
            </div>
        </div>
        <div class="error-message" id="kontenError"></div>
      </div>

      <div class="mb-3">
        <label for="author" class="form-label">Penulis</label>
        <input type="text" class="form-control" id="author" placeholder="Nama penulis" value="Bima Akbar" />
      </div>
      <div class="mb-3">
        <label for="slug" class="form-label">Slug</label>
        <input type="text" class="form-control" id="slug" placeholder="Slug URL otomatis, bisa diubah" />
        <div class="form-text">Contoh: judul-artikel-anda</div>
      </div>
      <div class="mb-3">
        <label for="metaTitle" class="form-label">Meta Title</label>
        <input type="text" class="form-control" id="metaTitle" placeholder="Judul untuk SEO (Google)" />
      </div>
      <div class="mb-3">
        <label for="metaDescription" class="form-label">Meta Description</label>
        <textarea class="form-control" id="metaDescription" maxlength="160" rows="2" placeholder="Ringkasan singkat untuk deskripsi SEO (maks. 160 karakter)"></textarea>
      </div>
      <div class="mb-3">
        <label for="keywords" class="form-label">Keywords</label>
        <input type="text" class="form-control" id="keywords" placeholder="Kata kunci utama" />
      </div>
      <div class="mb-3">
        <label for="status" class="form-label">Status</label>
        <select class="form-select" id="status">
          <option value="draft">Draf</option>
          <option value="published">Publik</option>
          <option value="scheduled">Terjadwal</option>
        </select>
      </div>
      <div class="mb-3" id="schedule-container" style="display: none;">
        <label for="schedule-time" class="form-label">Tanggal & Waktu Terjadwal</label>
        <input type="datetime-local" class="form-control" id="schedule-time" />
      </div>
      <button type="submit" class="btn btn-primary mt-3 rounded-pill" id="submitBtn">Simpan & Posting</button>
    </form>
  </div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const SUPABASE_URL = 'https://wgcslximcxnprmfqtsoh.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnY3NseGltY3hucHJtZnF0c29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTE5NzEsImV4cCI6MjA2NTMyNzk3MX0.K0xWAiVdU9vAwJepHV5rMBROBoBDTpXtczXoQopEZQk';
  
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const judulInput = document.getElementById('judul');
  const kategoriInput = document.getElementById('kategori');
  const tagInput = document.getElementById('tag');
  const thumbnailInput = document.getElementById('thumbnail');
  const thumbnailPreview = document.getElementById('thumbnailPreview');
  const editorDiv = document.getElementById('editor');
  const slugInput = document.getElementById('slug');
  const metaTitleInput = document.getElementById('metaTitle');
  const metaDescriptionInput = document.getElementById('metaDescription');
  const keywordsInput = document.getElementById('keywords');
  const statusInput = document.getElementById('status');
  const scheduleTimeInput = document.getElementById('schedule-time');
  const scheduleContainer = document.getElementById('schedule-container');
  const submitBtn = document.getElementById('submitBtn');
  const imageUploadInput = document.getElementById('imageUploadInput');
  const authorInput = document.getElementById('author'); 

  async function loadCategories() {
    kategoriInput.innerHTML = '<option value="" disabled selected>Memuat kategori...</option>';
    const { data, error } = await supabase
      .from('categories')
      .select('name')
      .order('name', { ascending: true });

    if (error) {
      console.error('Error memuat kategori:', error.message);
      kategoriInput.innerHTML = '<option value="" disabled selected>Gagal memuat kategori</option>';
      return;
    }

    kategoriInput.innerHTML = '<option value="" disabled selected>Pilih kategori</option>';
    data.forEach(category => {
      const option = document.createElement('option');
      option.value = category.name;
      option.textContent = category.name;
      kategoriInput.appendChild(option);
    });
  }

  async function loadPostForEdit() {
    const urlParams = new URLSearchParams(window.location.search);
    const postId = urlParams.get('id');

    if (postId) {
      submitBtn.textContent = 'Perbarui Postingan';
      document.querySelector('.header-bar h6').textContent = 'Edit Postingan';
      document.querySelector('section.py-4 h1').textContent = 'Edit Postingan';
      document.querySelector('section.py-4 p').textContent = 'Perbarui detail dan konten postingan Anda.';

      const { data, error } = await supabase
        .from('posts')
        .select('id, title, content, slug, thumbnail_url, category, tags, author, published, meta_title, meta_description, keywords, scheduled_time') 
        .eq('id', postId)
        .single();

      if (error) {
        console.error('Error memuat postingan:', error.message);
        alert('Gagal memuat postingan untuk diedit.');
        return;
      }

      if (data) {
        judulInput.value = data.title || '';
        kategoriInput.value = data.category || '';
        tagInput.value = data.tags || '';
        editorDiv.innerHTML = data.content || '';
        slugInput.value = data.slug || '';
        metaTitleInput.value = data.meta_title || '';
        metaDescriptionInput.value = data.meta_description || '';
        keywordsInput.value = data.keywords || '';
        
        authorInput.value = data.author || 'Bima Akbar';
        
        if (data.published) {
            statusInput.value = 'published';
            scheduleContainer.style.display = 'none';
        } else if (data.scheduled_time) {
            statusInput.value = 'scheduled';
            scheduleContainer.style.display = 'block';
            scheduleTimeInput.value = new Date(data.scheduled_time).toISOString().slice(0, 16);
        } else {
            statusInput.value = 'draft';
            scheduleContainer.style.display = 'none';
        }

        if (data.thumbnail_url) {
          thumbnailPreview.src = data.thumbnail_url;
          thumbnailPreview.style.display = 'block';
        } else {
            thumbnailPreview.src = '';
            thumbnailPreview.style.display = 'none';
        }

        const firstBlock = editorDiv.querySelector('h1, h2, h3, h4, h5, h6, p, div');
        if (firstBlock) {
            const tag = firstBlock.tagName;
            if (tag.toLowerCase() === 'p' || tag.toLowerCase() === 'div') {
                document.getElementById('currentHeadingIcon').className = 'bi bi-paragraph';
            } else {
                document.getElementById('currentHeadingIcon').className = `bi bi-type-${tag.toLowerCase()}`;
            }
        } else {
            document.getElementById('currentHeadingIcon').className = 'bi bi-type-h2';
        }
      }
    }
  }

  judulInput.addEventListener('input', function () {
    const val = this.value.trim().toLowerCase().replace(/[^\w\s-]/g, '').replace(/\s+/g, '-');
    if (!slugInput.value || slugInput.dataset.manualEdit !== 'true') {
      slugInput.value = val;
    }
    if (!metaTitleInput.value) metaTitleInput.value = this.value;
    document.getElementById('judulError').textContent = '';
  });

  slugInput.addEventListener('input', function() {
    this.dataset.manualEdit = 'true';
  });

  kategoriInput.addEventListener('change', function () {
    document.getElementById('kategoriError').textContent = '';
  });

  editorDiv.addEventListener('input', function () {
    document.getElementById('kontenError').textContent = '';
  });

  statusInput.addEventListener('change', function () {
    scheduleContainer.style.display = this.value === 'scheduled' ? 'block' : 'none';
  });

  thumbnailInput.addEventListener('change', function() {
    const file = this.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        thumbnailPreview.src = e.target.result;
        thumbnailPreview.style.display = 'block';
      }
      reader.readAsDataURL(file);
    } else {
      thumbnailPreview.src = '';
      thumbnailPreview.style.display = 'none';
    }
  });

  function formatHeading(headingTag, iconClass) {
    document.execCommand('formatBlock', false, headingTag);
    document.getElementById('currentHeadingIcon').className = 'bi ' + iconClass; // Update ikon
    editorDiv.focus(); 
  }

  function formatParagraph(iconClass = 'bi-paragraph') { // Default icon for paragraph
    document.execCommand('formatBlock', false, 'p');
    document.getElementById('currentHeadingIcon').className = 'bi ' + iconClass;
    editorDiv.focus();
  }

  function alignText(command, iconClass) {
    document.execCommand(command, false, null);
    document.getElementById('currentAlignmentIcon').className = 'bi ' + iconClass; // Update ikon
    editorDiv.focus();
  }

  function tambahLink() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return;
    const range = selection.getRangeAt(0);
    
    const savedRange = selection.getRangeAt(0);

    const url = prompt("Masukkan URL:");
    if (url) {
      document.execCommand("createLink", false, url);
    }

    if (savedRange) {
        selection.removeAllRanges();
        selection.addRange(savedRange);
    }
    editorDiv.focus();
  }

  function triggerImageUpload() {
      imageUploadInput.click(); 
  }

  imageUploadInput.addEventListener('change', async function() {
    const file = this.files[0];
    if (!file) return;

    const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/gif', 'image/webp'];
    const maxSize = 5 * 1024 * 1024;

    if (!allowedTypes.includes(file.type)) {
      alert('Format gambar tidak didukung. Gunakan JPG, JPEG, PNG, GIF, atau WEBP.');
      this.value = ''; 
      return;
    }
    if (file.size > maxSize) {
      alert('Ukuran gambar terlalu besar. Maksimal 5MB.');
      this.value = ''; 
      return;
    }

    const savedRange = window.getSelection().rangeCount > 0 ? window.getSelection().getRangeAt(0) : null;

    const imageButton = document.querySelector('button[onclick="triggerImageUpload()"]');
    const originalContent = imageButton.innerHTML; 
    imageButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>'; 
    imageButton.disabled = true;

    try {
      const fileName = `editor_images/${Date.now()}_${file.name}`; 
      const { data: uploadData, error: uploadError } = await supabase.storage.from('bimaakbar.thumbnail').upload(fileName, file);
      if (uploadError) {
        alert('Gagal mengunggah gambar: ' + uploadError.message);
        return;
      }

      const { data: publicUrlData } = supabase.storage.from('bimaakbar.thumbnail').getPublicUrl(fileName);
      const imageUrl = publicUrlData.publicUrl;
      console.log("Generated Image URL:", imageUrl); 

      if (savedRange) {
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(savedRange);
      }
      document.execCommand('insertImage', false, imageUrl);
      editorDiv.focus(); 

    } catch (error) {
      console.error('Error during image upload:', error);
      alert('Terjadi kesalahan saat mengunggah gambar.');
    } finally {
      imageButton.innerHTML = originalContent; 
      imageButton.disabled = false;
      this.value = ''; 
    }
  });

  function openPreview() {
    console.log('[DEBUG] Tombol Pratinjau diklik!'); // Tambahkan log ini
    const postDataForPreview = {
        judul: judulInput.value,
        kategori: kategoriInput.value,
        tag: tagInput.value,
        konten: editorDiv.innerHTML,
        thumbnail_url: thumbnailPreview.src && thumbnailPreview.style.display !== 'none' ? thumbnailPreview.src : '',
        meta_title: metaTitleInput.value,
        meta_description: metaDescriptionInput.value,
        keywords: keywordsInput.value,
        author: authorInput.value,
        status: statusInput.value
    };

    localStorage.setItem('previewPostData', JSON.stringify(postDataForPreview));

    window.open('post-preview.html', '_blank');
  }

  document.getElementById('postForm').addEventListener('submit', async function (e) {
    e.preventDefault();

    let isValid = true;
    const thumbnailErrorDiv = document.getElementById('thumbnailError');

    if (!judulInput.value.trim()) {
      document.getElementById('judulError').textContent = 'Judul wajib diisi.';
      isValid = false;
    }
    if (!kategoriInput.value) {
      document.getElementById('kategoriError').textContent = 'Kategori wajib dipilih.';
      isValid = false;
    }
    if (!editorDiv.innerText.trim()) { 
      document.getElementById('kontenError').textContent = 'Konten tidak boleh kosong.';
      isValid = false;
    }
    // Perbaikan: Hapus karakter 'a' yang tidak pada tempatnya
    if (!slugInput.value.trim()) {
        slugInput.value = judulInput.value.trim().toLowerCase().replace(/\s+/g, '-').replace(/^-+|-+$/g, '');
        if (!slugInput.value.trim()) {
            alert('Slug tidak boleh kosong.');
            isValid = false;
        }
    }

    if (thumbnailInput.files.length > 0) {
      const file = thumbnailInput.files.item(0);
      const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg', 'image/webp'];
      const maxSize = 2 * 1024 * 1024; // 2MB

      if (!allowedTypes.includes(file.type)) {
        thumbnailErrorDiv.textContent = 'Format gambar tidak didukung. Gunakan JPG, JPEG, PNG, atau WEBP.';
        isValid = false;
      } else if (file.size > maxSize) {
        thumbnailErrorDiv.textContent = 'Ukuran gambar terlalu besar. Maksimal 2MB.';
        isValid = false;
      } else {
        thumbnailErrorDiv.textContent = ''; 
      }
    } else {
      thumbnailErrorDiv.textContent = ''; 
    }

    if (statusInput.value === 'scheduled' && !scheduleTimeInput.value) {
        alert('Tanggal & Waktu Terjadwal wajib diisi jika status Terjadwal.');
        isValid = false;
    }

    if (!isValid) {
      return;
    }

    const postId = new URLSearchParams(window.location.search).get('id');
    const isEditing = !!postId;

    const title = judulInput.value.trim();
    const category = kategoriInput.value === '' ? null : kategoriInput.value;
    const tags = tagInput.value.trim() === '' ? null : tagInput.value.trim();
    const content = editorDiv.innerHTML.trim();
    const slug = slugInput.value.trim();
    const meta_title = metaTitleInput.value.trim() === '' ? null : metaTitleInput.value.trim();
    const meta_description = metaDescriptionInput.value.trim() === '' ? null : metaDescriptionInput.value.trim();
    const keywords = keywordsInput.value.trim() === '' ? null : keywordsInput.value.trim();
    const author = authorInput.value.trim() === '' ? null : authorInput.value.trim();

    let published = false;
    let scheduled_time = null;

    if (statusInput.value === 'published') {
        published = true;
    } else if (statusInput.value === 'scheduled') {
        published = false;
        scheduled_time = scheduleTimeInput.value;
    } else { // 'draft'
        published = false;
    }

    const file = thumbnailInput.files ? thumbnailInput.files.item(0) : null;
    let thumbnail_url = thumbnailPreview.src && thumbnailPreview.style.display !== 'none' ? thumbnailPreview.src : null;

    submitBtn.disabled = true;
    submitBtn.textContent = isEditing ? 'Memperbarui...' : 'Mengunggah...';

    if (file) {
      const fileName = `thumbnails/${Date.now()}_${file.name}`; 
      const { data: uploadData, error: uploadError } = await supabase.storage.from('bimaakbar.thumbnail').upload(fileName, file);
      if (uploadError) {
        alert('Gagal upload thumbnail: ' + uploadError.message);
        submitBtn.disabled = false;
        submitBtn.textContent = isEditing ? 'Perbarui Postingan' : 'Simpan & Posting';
        return;
      }
      const { data: publicUrl } = supabase.storage.from('bimaakbar.thumbnail').getPublicUrl(fileName);
      thumbnail_url = publicUrl.publicUrl;
    } else if (isEditing && !thumbnailInput.value && thumbnailPreview.style.display === 'none') {
        thumbnail_url = null;
    }

    const postData = {
      title: title, 
      category: category, 
      tags: tags, 
      content: content, 
      slug: slug, 
      meta_title: meta_title,
      meta_description: meta_description, 
      keywords: keywords, 
      published: published,
      scheduled_time: scheduled_time, 
      thumbnail_url: thumbnail_url,
      author: author,
    };

    let dbOperation;
    if (isEditing) {
      postData.updated_at = new Date();
      dbOperation = supabase.from('posts').update(postData).eq('id', postId);
    } else {
      postData.created_at = new Date();
      dbOperation = supabase.from('posts').insert([postData]);
    }

    const { error: dbError } = await dbOperation;

    submitBtn.disabled = false;
    submitBtn.textContent = isEditing ? 'Perbarui Postingan' : 'Simpan & Posting';

    if (dbError) {
      alert('Gagal menyimpan postingan: ' + dbError.message);
    } else {
      alert(isEditing ? 'Berhasil diperbarui!' : 'Berhasil disimpan!');
      if (!isEditing) {
        document.getElementById('postForm').reset();
        thumbnailPreview.src = '';
        thumbnailPreview.style.display = 'none';
        scheduleContainer.style.display = 'none';
        editorDiv.innerHTML = '';
        editorDiv.focus();
        // Reset heading and alignment to default after new post
        document.getElementById('currentHeadingIcon').className = 'bi bi-type-h2';
        document.getElementById('currentAlignmentIcon').className = 'bi bi-text-left';
        slugInput.dataset.manualEdit = 'false';
      }
    }
  });

  // --- Inisialisasi Tooltips Bootstrap ---
  function initializeTooltips() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
      return new bootstrap.Tooltip(tooltipTriggerEl)
    })
  }

  document.addEventListener('DOMContentLoaded', async () => {
    console.log('DOM Content Loaded. Bootstrap Icons should be visible.'); 
    await loadCategories();
    await loadPostForEdit();
    initializeTooltips();
  });
</script>
</body>
</html>

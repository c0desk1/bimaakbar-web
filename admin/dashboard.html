<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0a0a0a; color: #a3a3a3; }
        .glass-card { background-color: rgba(23, 23, 23, 0.6); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .nav-item.active i, .nav-item.active span { color: #818cf8; }
    </style>
</head>
<body class="min-h-screen">

    <main id="app" class="pb-24 px-4 pt-8 opacity-0 transition-opacity duration-500">
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 id="greeting" class="text-3xl font-bold text-white"></h1>
                <p class="text-gray-400">Selamat datang di Content Hub Anda.</p>
            </div>
            <a href="tambah_postingan.html" class="bg-indigo-500 text-white font-semibold py-2 px-4 rounded-xl shadow-lg hover:bg-indigo-600 transition-all flex items-center">
                <i class="ri-add-line mr-2"></i>Buat Postingan
            </a>
        </header>

        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
            <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Total Views</p><p id="totalViews" class="text-2xl font-bold text-white">...</p></div>
            <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Total Posts</p><p id="totalPosts" class="text-2xl font-bold text-white">...</p></div>
            <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Published</p><p id="publishedPosts" class="text-2xl font-bold text-green-400">...</p></div>
            <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Drafts</p><p id="draftPosts" class="text-2xl font-bold text-amber-400">...</p></div>
        </div>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 space-y-8">
                <div>
                    <h2 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h2>
                    <div id="recentPostsList" class="space-y-3"></div>
                </div>
            </div>
            <div class="space-y-8">
                <div>
                    <h3 class="text-xl font-semibold text-white mb-4">Postingan Terpopuler</h3>
                    <div id="popularPostsList" class="space-y-3"></div>
                </div>
                 <div>
                    <h3 class="text-xl font-semibold text-white mb-4">Informasi Sistem</h3>
                    <div id="systemInfo" class="glass-card p-4 rounded-2xl text-sm space-y-2"></div>
                </div>
            </div>
        </div>
    </main>
    
    <nav class="fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center" style="border-top: 1px solid rgba(255, 255, 255, 0.1); background: linear-gradient(180deg, rgba(10, 10, 10, 0.7) 0%, rgba(10, 10, 10, 0.9) 100%); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);">
        <a href="dashboard.html" class="nav-item flex flex-col items-center justify-center text-indigo-400"><i class="ri-dashboard-3-line text-2xl"></i><span class="text-xs mt-1">Home</span></a>
        <a href="content-studio.html" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-pencil-ruler-2-line text-2xl"></i><span class="text-xs mt-1">Konten</span></a>
        <a href="#" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-music-2-line text-2xl"></i><span class="text-xs mt-1">Musik</span></a>
        <a href="#" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-shopping-bag-3-line text-2xl"></i><span class="text-xs mt-1">Afiliasi</span></a>
        <button id="logoutButton" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-logout-box-r-line text-2xl"></i><span class="text-xs mt-1">Logout</span></button>
    </nav>
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SUPABASE_URL = 'https://wgcslximcxnprmfqtsoh.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndnY3NseGltY3hucHJtZnF0c29oIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk3NTE5NzEsImV4cCI6MjA2NTMyNzk3MX0.K0xWAiVdU9vAwJepHV5rMBROBoBDTpXtczXoQopEZQk';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        async function fetchDashboardData() {
            // ... (Fungsi mengambil data, sama seperti sebelumnya, tapi kita tambah total views)
            const [postsRes, popularPostsRes, totalViewsRes] = await Promise.all([
                supabase.from('posts').select('id, published'),
                supabase.from('posts').select('title, views').order('views', { ascending: false }).limit(3),
                supabase.rpc('get_total_views')
            ]);
            
            // Update Statistik
            if (!postsRes.error) {
                const posts = postsRes.data;
                const publishedCount = posts.filter(p => p.published).length;
                document.getElementById('totalPosts').textContent = posts.length;
                document.getElementById('publishedPosts').textContent = publishedCount;
                document.getElementById('draftPosts').textContent = posts.length - publishedCount;
            }
            if (!totalViewsRes.error) {
                document.getElementById('totalViews').textContent = totalViewsRes.data;
            }

            // Update Postingan Terpopuler
            if (!popularPostsRes.error && popularPostsRes.data.length > 0) {
                const list = document.getElementById('popularPostsList');
                list.innerHTML = '';
                popularPostsRes.data.forEach(post => {
                    const el = document.createElement('div');
                    el.className = 'glass-card p-3 rounded-xl flex justify-between items-center text-sm';
                    el.innerHTML = `<p class="font-medium text-white truncate pr-4">${post.title}</p><p class="text-gray-400 flex-shrink-0">${post.views} views</p>`;
                    list.appendChild(el);
                });
            }
        }

        function displaySystemInfo() {
            const infoContainer = document.getElementById('systemInfo');
            const onlineStatus = navigator.onLine ? '<span class="text-green-400">Online</span>' : '<span class="text-red-400">Offline</span>';
            supabase.from('posts').select('id', { count: 'exact', head: true }).then(({error}) => {
                const supabaseStatus = error ? '<span class="text-red-400">Error</span>' : '<span class="text-green-400">Connected</span>';
                 infoContainer.innerHTML = `
                    <div class="flex justify-between"><span>Koneksi Browser:</span> <span class="font-semibold">${onlineStatus}</span></div>
                    <div class="flex justify-between"><span>Koneksi Supabase:</span> <span class="font-semibold">${supabaseStatus}</span></div>
                    <div class="flex justify-between"><span>Waktu Lokal:</span> <span class="font-semibold">${new Date().toLocaleTimeString('id-ID')}</span></div>
                `;
            });
        }
        
        async function initializePage() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.replace('login.html');
                return;
            }
            document.getElementById('app').classList.remove('opacity-0');

            const hour = new Date().getHours();
            document.getElementById('greeting').textContent = (hour < 11) ? 'Selamat Pagi' : (hour < 15) ? 'Selamat Siang' : 'Selamat Malam';
            
            fetchDashboardData();
            displaySystemInfo();
            // Refresh info sistem setiap 30 detik
            setInterval(displaySystemInfo, 30000);

            document.getElementById('logoutButton').addEventListener('click', async () => {
                await supabase.auth.signOut();
                window.location.replace('login.html');
            });
        }

        document.addEventListener('DOMContentLoaded', initializePage);
    </script>
</body>
</html>

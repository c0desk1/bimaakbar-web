<!DOCTYPE html>
<html lang="id">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0">
		<script src="scripts/supabaseConfig.js"></script> 
    	<title>Dashboard</title>
    	<link rel="icon" type="image/png" href="assets/favicon/favicon-96x96.png" sizes="96x96" />
		<link rel="icon" type="image/svg+xml" href="assets/favicon/favicon.svg" />
		<link rel="shortcut icon" href="assets/favicon/favicon.ico" />
		<link rel="apple-touch-icon" sizes="180x180" href="assets/favicon/apple-touch-icon.png" />
		<meta name="apple-mobile-web-app-title" content="Bima Akbar" />
		<link rel="manifest" href="assets/favicon/site.webmanifest" />
		<link href="styles/globals.css" rel="stylesheet"/>
		<link href="styles/custom.css" rel="stylesheet"/>
    	<script src="https://cdn.tailwindcss.com"></script>
    	<link href="https://cdn.jsdelivr.net/npm/remixicon@4.2.0/fonts/remixicon.css" rel="stylesheet"/>
	</head>
	<body class="min-h-screen">
	
		<header class="py-3 px-4 sm:px-6 lg:px-8 border-b border-white/10 bg-[#0a0a0a]/80 backdrop-blur-sm sticky top-0 z-40">
			<div class="flex items-center justify-between">
				<div id="user-name-header" class="text-lg font-semibold text-white"></div>
				<div id="live-presence-indicator" class="flex items-center space-x-2 bg-neutral-800/50 py-1 px-3 rounded-full">
					<div id="live-dot" class="w-2 h-2 rounded-full bg-green-500"></div>
					<span id="live-count" class="text-xs font-medium text-slate-300"></span>
				</div>
				<div class="relative">
					<button id="avatar-button" class="block">
						<img id="user-avatar-img" src="" alt="Foto Profil" class="w-10 h-10 rounded-full object-cover ring-2 ring-offset-2 ring-offset-[#0a0a0a] ring-indigo-500">
					</button>
					<div id="profile-dropdown" class="hidden absolute right-0 mt-2 w-48 bg-neutral-800 border border-white/10 rounded-lg shadow-lg py-1 z-50">
						<a href="#" id="logout-btn-dropdown" class="flex items-center w-full px-4 py-2 text-sm text-red-400 hover:bg-red-500/20">
							<i class="ri-logout-box-r-line mr-2"></i>Logout
						</a>
					</div>
				</div>
			</div>
		</header>

    	<main id="app" class="pb-24 px-4 pt-8 opacity-0 transition-opacity duration-500"></main>   
    
	    <nav class="fixed bottom-0 left-0 right-0 h-20 flex justify-around items-center" style="border-top: 1px solid rgba(255, 255, 255, 0.1); background: linear-gradient(180deg, rgba(10, 10, 10, 0.7) 0%, rgba(10, 10, 10, 0.9) 100%); backdrop-filter: blur(12px);">
		    <button data-view="home" class="nav-item flex flex-col items-center justify-center text-gray-400 active"><i class="ri-dashboard-3-line text-2xl"></i><span class="text-xs mt-1">Home</span></button>
		    <a href="content-studio.html" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-pencil-ruler-2-line text-2xl"></i><span class="text-xs mt-1">Konten</span></a>
		    <button data-view="stats" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-bar-chart-2-line text-2xl"></i><span class="text-xs mt-1">Statistik</span></button>
		    <button data-view="comments" class="nav-item relative flex flex-col items-center justify-center text-gray-400">
		        <i class="ri-chat-4-line text-2xl"></i><span class="text-xs mt-1">Komentar</span>
		        <span id="comment-badge" class="hidden absolute top-0 right-2 w-5 h-5 bg-red-500 text-white text-[10px] font-bold rounded-full flex items-center justify-center border-2 border-[#0a0a0a]"></span>
		    </button>
		    <button data-view="settings" class="nav-item flex flex-col items-center justify-center text-gray-400"><i class="ri-settings-3-line text-2xl"></i><span class="text-xs mt-1">Pengaturan</span></button>
		</nav>
	
    	<template id="view-home">
	        <div class="space-y-8">
	            <div><h1 id="greeting" class="text-3xl font-bold text-white"></h1><p class="text-gray-400">Selamat datang di Studio.</p></div>
	            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
	                <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Total Views</p><p id="totalViews" class="text-2xl font-bold text-white">...</p></div>
	                <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Total Posts</p><p id="totalPosts" class="text-2xl font-bold text-white">...</p></div>
	                <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Published</p><p id="publishedPosts" class="text-2xl font-bold text-green-400">...</p></div>
	                <div class="glass-card p-4 rounded-2xl"><p class="text-sm text-gray-400">Drafts</p><p id="draftPosts" class="text-2xl font-bold text-amber-400">...</p></div>
	            </div>
	            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
	    			<div class="lg:col-span-2">
	        			<h2 class="text-xl font-semibold text-white mb-4">Postingan Terpopuler</h2>
	        			<div id="popularPostsList" class="space-y-3"></div>
	    			</div>
	    			<div>
	        			<h3 class="text-xl font-semibold text-white mb-4">Aktivitas Terbaru</h3>
	        			<div id="recentActivityList" class="space-y-3"></div>
	    			</div>
				</div>
	        </div>
    	</template>
    
	    <template id="view-comments">
			<h1 class="text-3xl font-bold text-white mb-6">Moderasi Komentar</h1>
			<div class="border-b border-white/10 mb-6">
				<nav id="comment-tabs" class="-mb-px flex space-x-6">
					<button data-filter="pending" class="comment-tab-btn py-3 px-1 text-sm font-semibold">Perlu Persetujuan</button>
					<button data-filter="all" class="comment-tab-btn py-3 px-1 text-sm font-semibold text-gray-400">Semua Komentar</button>
				</nav>
			</div>
			<form id="comment-search-form" class="mb-6">
				<div class="relative">
					<input type="search" id="comment-search-input" placeholder="Cari berdasarkan nama atau isi komentar..." class="w-full bg-neutral-800/50 text-white p-3 pl-10 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
					<div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
						<i class="ri-search-line text-gray-400"></i>
					</div>
				</div>
			</form>
			<div id="comments-list" class="space-y-4"></div>
			<div id="pagination-controls" class="hidden mt-8 flex justify-between items-center">
				<button id="prev-page-btn" class="glass-card py-2 px-4 rounded-lg text-sm font-semibold hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">Sebelumnya</button>
				<span id="page-info" class="text-sm text-slate-400"></span>
				<button id="next-page-btn" class="glass-card py-2 px-4 rounded-lg text-sm font-semibold hover:bg-neutral-700 disabled:opacity-50 disabled:cursor-not-allowed">Berikutnya</button>
			</div>
		</template>

	    <template id="view-stats">
		    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-6">
		        <h1 class="text-3xl font-bold text-white">Statistik Detail</h1> 
		        <div id="date-filter-buttons" class="flex items-center space-x-2 mt-4 sm:mt-0 bg-neutral-800/50 p-1 rounded-lg">
		            <button data-range="7" class="date-filter-btn px-3 py-1 text-sm rounded-md">7 Hari</button>
		            <button data-range="30" class="date-filter-btn px-3 py-1 text-sm rounded-md active">30 Hari</button>
		            <button data-range="all" class="date-filter-btn px-3 py-1 text-sm rounded-md">Semua</button>
		        </div>
		    </div>
		    <div class="space-y-8"></div>
			<div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
				<div class="lg:col-span-2 space-y-8">
					<div class="glass-card p-6 rounded-2xl">
						<h2 class="text-lg font-semibold text-white mb-4">Tren Views Harian</h2>
						<div class="h-80"><canvas id="monthlyViewsChart"></canvas></div>
					</div>
					<div class="glass-card p-6 rounded-2xl">
						<h2 class="text-lg font-semibold text-white mb-4">Performa Semua Postingan</h2>
						<div class="overflow-x-auto">
							<table id="posts-performance-table" class="w-full text-sm text-left">
								<thead class="text-xs text-gray-400 uppercase">
									<tr>
										<th class="py-3 px-4">Judul Postingan</th>
										<th class="py-3 px-4">Views</th>
										<th class="py-3 px-4">Komentar</th>
									</tr>
								</thead>
								<tbody class="divide-y divide-white/10"></tbody>
							</table>
						</div>
					</div>
				</div>
				<div class="lg:col-span-1 space-y-8">
					<div class="glass-card p-6 rounded-2xl">
						<h2 class="text-lg font-semibold text-white mb-4">Post per Kategori</h2>
						<div class="h-80"><canvas id="postsByCategoryChart"></canvas></div>
					</div>
				</div>
			</div>
		</template>

	
		<template id="view-settings">
		    <h1 class="text-3xl font-bold text-white mb-6">Pengaturan & Log</h1>
		    <div class="border-b border-white/10 mb-6">
		        <nav id="settings-tabs" class="-mb-px flex space-x-6">
		            <button data-tab="profile" class="settings-tab-btn py-3 px-1 text-sm font-semibold active">Profil</button>
		            <button data-tab="activity" class="settings-tab-btn py-3 px-1 text-sm font-semibold text-gray-400">Log Aktivitas</button>
		            <button data-tab="error" class="settings-tab-btn py-3 px-1 text-sm font-semibold text-gray-400">Log Error</button>
		        </nav>
		    </div>
		
		    <div>
		        <div id="tab-content-profile" class="tab-content space-y-8">
					<div class="glass-card p-6 rounded-2xl">
						<h2 class="text-lg font-semibold text-white mb-1">Profil Anda</h2>
						<p class="text-sm text-slate-400 mb-4">Pengaturan terkait akun Anda.</p>
						
						<div class="flex items-center space-x-4 mb-6">
							<img id="settings-avatar" src="" class="w-16 h-16 rounded-full object-cover">
							<div>
								<p class="font-bold text-white">Foto Profil</p>
								<p class="text-sm text-slate-300">Ganti foto profil Anda.</p>
								<button id="change-avatar-btn" class="mt-2 bg-neutral-700 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-neutral-600">Ubah Foto</button>
								<input type="file" id="avatar-upload-input" class="hidden" accept="image/png, image/jpeg">
							</div>
						</div>
					
						<div class="border-t border-white/10 pt-4">
							<div class="flex justify-between items-center">
								<div>
									<p class="font-bold text-white">Nama Tampilan</p>
									<p id="settings-username" class="text-sm text-slate-300"></p>
									<input id="edit-name-input" type="text" class="hidden bg-neutral-700 text-white p-2 rounded-md w-full" />
								</div>
								<button id="edit-name-btn" class="bg-indigo-500/20 text-indigo-300 text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-500/40">Edit</button>
							</div>
							<div id="edit-name-actions" class="hidden flex justify-end space-x-2 mt-3">
								<button id="cancel-edit-name-btn" class="text-xs font-semibold py-1 px-3 rounded-full hover:bg-neutral-700">Batal</button>
								<button id="save-name-btn" class="bg-indigo-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-600">Simpan</button>
							</div>
						</div>
					
						<div class="border-t border-white/10 pt-4 mt-4">
							<p class="font-bold text-white">Email</p>
							<p id="settings-email" class="text-sm text-slate-300">email@pengguna.com</p>
						</div>
					</div>
					<div class="glass-card p-6 rounded-2xl">
						<h2 class="text-lg font-semibold text-white mb-1">Keamanan</h2>
						<p class="text-sm text-slate-400 mb-4">Kelola keamanan akun Anda.</p>
						<button id="change-password-btn" class="bg-indigo-500 text-white text-sm font-bold py-2 px-4 rounded-lg hover:bg-indigo-600">
							Ubah Password
						</button>
					</div>
				</div>
		        <div id="tab-content-activity" class="tab-content hidden space-y-4"></div>
		        <div id="tab-content-error" class="tab-content hidden space-y-4"></div>
		    </div>
		</template>

	    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
	        <div class="glass-card w-full max-w-sm p-6 rounded-2xl border-red-500/50 text-center">
	            <h3 class="text-xl font-bold text-white mb-2">Konfirmasi Hapus</h3>
	            <p id="modal-text" class="text-slate-300 text-sm mb-6">Apakah Anda yakin ingin menghapus item ini secara permanen? Tindakan ini tidak dapat dibatalkan.</p>
	            <div class="flex justify-center space-x-4">
	                <button id="cancel-delete-btn" class="py-2 px-5 rounded-full text-sm font-semibold hover:bg-neutral-700 transition-colors">Batal</button>
	                <button id="confirm-delete-btn" class="bg-red-600 hover:bg-red-700 text-white py-2 px-5 rounded-full text-sm font-bold transition-colors">Ya, Hapus</button>
	            </div>
	        </div>
	    </div>

		<div id="change-password-modal" class="hidden fixed inset-0 bg-black/60 backdrop-blur-sm flex items-center justify-center p-4 z-50">
			<div class="glass-card w-full max-w-sm p-6 rounded-2xl">
				<h3 class="text-xl font-bold text-white mb-4">Ubah Password Baru</h3>
				<form id="change-password-form" class="space-y-4">
					<div>
						<label for="new-password" class="block text-sm font-medium text-slate-300 mb-1">Password Baru</label>
						<input type="password" id="new-password" class="w-full bg-neutral-700 text-white p-2 rounded-md" required minlength="6">
					</div>
					<div>
						<label for="confirm-password" class="block text-sm font-medium text-slate-300 mb-1">Konfirmasi Password Baru</label>
						<input type="password" id="confirm-password" class="w-full bg-neutral-700 text-white p-2 rounded-md" required minlength="6">
					</div>
					<div class="flex justify-end space-x-3 pt-4">
						<button type="button" id="cancel-password-change-btn" class="py-2 px-4 rounded-lg text-sm font-semibold hover:bg-neutral-700">Batal</button>
						<button type="submit" id="save-password-change-btn" class="bg-indigo-500 text-white py-2 px-5 rounded-lg text-sm font-bold hover:bg-indigo-600">Simpan Password</button>
					</div>
				</form>
			</div>
		</div>
	    
		<div id="toast-container" class="fixed top-8 right-8 space-y-3 z-50"></div>
    
	    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
	    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
	    <script>
	        document.addEventListener('DOMContentLoaded', () => {
	            const supabase = window.supabase.createClient(SUPABASE_CONFIG.URL, SUPABASE_CONFIG.ANON_KEY);
	            
	            const app = document.getElementById('app');
	            const navItems = document.querySelectorAll('.nav-item');
	            const commentBadge = document.getElementById('comment-badge');
				const confirmationModal = document.getElementById('confirmation-modal');
	        	const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
	        	const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
	            let charts = {};
	
	            // --- FUNGSI RENDER UTAMA ---
	            async function renderView(viewName = 'home') {
	                const template = document.getElementById(`view-${viewName}`);
	                if (template) app.innerHTML = template.innerHTML;
	                
	                document.querySelectorAll('.nav-item.active').forEach(i => i.classList.remove('active'));
	                const newActiveItem = document.querySelector(`.nav-item[data-view="${viewName}"]`);
	                if (newActiveItem) newActiveItem.classList.add('active');
	
	                if (viewName === 'home') await renderHomeView();
	                if (viewName === 'comments') await renderCommentsView();
	                if (viewName === 'stats') await renderStatsView();
					if (viewName === 'settings') await renderSettingsView();
	            }
	
	            // --- FUNGSI VIEW: HOME ---
	            async function renderHomeView() {
					const hour = new Date().getHours();
					document.getElementById('greeting').textContent = (hour < 11) ? 'Selamat Pagi' : (hour < 15) ? 'Selamat Siang' : 'Selamat Malam';
					document.getElementById('popularPostsList').innerHTML = getPopularPostsSkeletonHTML();
					
					// Set stat cards ke mode loading
					document.getElementById('totalViews').textContent = '...';
					document.getElementById('totalPosts').textContent = '...';
					document.getElementById('publishedPosts').textContent = '...';
					document.getElementById('draftPosts').textContent = '...';

					const [postsRes, popularPostsRes, totalViewsRes, _] = await Promise.all([
						supabase.from('posts').select('id, published'),
						supabase.from('posts').select('title, views').order('views', { ascending: false }).limit(5),
						supabase.rpc('get_total_views'),
						renderRecentActivity()
					]);

					if (!postsRes.error && postsRes.data) {
						const posts = postsRes.data;
						document.getElementById('totalPosts').textContent = posts.length;
						document.getElementById('publishedPosts').textContent = posts.filter(p => p.published).length;
						document.getElementById('draftPosts').textContent = posts.length - posts.filter(p => p.published).length;
					}
					if (!totalViewsRes.error) { document.getElementById('totalViews').textContent = totalViewsRes.data || 0; }
					
					if (!popularPostsRes.error && popularPostsRes.data.length > 0) {
						const list = document.getElementById('popularPostsList');
						list.innerHTML = '';
						popularPostsRes.data.forEach(post => {
							list.innerHTML += `<div class="glass-card p-3 rounded-xl flex justify-between items-center text-sm"><p class="font-medium text-white truncate pr-4">${post.title}</p><p class="text-gray-400 flex-shrink-0">${post.views || 0} views</p></div>`;
						});
					} else if (document.getElementById('popularPostsList')) {
						document.getElementById('popularPostsList').innerHTML = '<p class="text-sm text-slate-500">Belum ada postingan populer.</p>';
					}
				}
	            
	            // --- FUNGSI VIEW: KOMENTAR ---
	            async function renderCommentsView() {
				    let currentPage = 1;
				    const commentsPerPage = 5;
				    let currentFilter = 'pending';
					let currentSearchTerm = '';
				
				    const listContainer = document.getElementById('comments-list');
				    const tabsContainer = document.getElementById('comment-tabs');
					const searchForm = document.getElementById('comment-search-form');
					const searchInput = document.getElementById('comment-search-input');
				    const paginationControls = document.getElementById('pagination-controls');
				    const prevPageBtn = document.getElementById('prev-page-btn');
				    const nextPageBtn = document.getElementById('next-page-btn');
				    const pageInfo = document.getElementById('page-info');
				
				    // --- FUNGSI KOMENTAR: LOADS ---
					async function loadComments(page, filter, searchTerm) {
						listContainer.innerHTML = getCommentSkeletonHTML();
						paginationControls.classList.add('hidden');

						const from = (page - 1) * commentsPerPage;
						const to = from + commentsPerPage - 1;

						let query = supabase.from('comments')
							.select('id, created_at, content, author_name, is_approved, post_id, posts(title, slug)', { count: 'exact' })
							.order('created_at', { ascending: false })
							.range(from, to);

						if (filter === 'pending') {
							query = query.eq('is_approved', false);
						}

						if (searchTerm) {
							query = query.or(`author_name.ilike.%${searchTerm}%,content.ilike.%${searchTerm}%`);
						}
				        
				        const { data: comments, error, count: totalComments } = await query;
				
				        if (error) { listContainer.innerHTML = `<p class="text-center text-red-400">Gagal memuat komentar.</p>`; return; }
        				if (comments.length === 0) { listContainer.innerHTML = `<p class="text-center text-slate-500 p-8">Tidak ada komentar yang cocok.</p>`; return; }
				
				        listContainer.innerHTML = '';
				        comments.forEach(comment => {
				            const card = document.createElement('div');
				            card.className = 'glass-card p-4 rounded-xl';
				            
				            let actionButtons = `<button onclick="window.replyToComment('${comment.id}', '${comment.post_id}')" class="bg-blue-500/20 text-blue-400 hover:bg-blue-500/40 text-xs font-bold py-1 px-3 rounded-full">Balas</button>
				                               <button onclick="window.deleteComment('${comment.id}')" class="bg-red-500/20 text-red-400 hover:bg-red-500/40 text-xs font-bold py-1 px-3 rounded-full">Hapus</button>`;
				            
				            if (!comment.is_approved) {
				                actionButtons = `<button onclick="window.approveComment('${comment.id}')" class="bg-green-500/20 text-green-400 hover:bg-green-500/40 text-xs font-bold py-1 px-3 rounded-full">Setujui</button>` + actionButtons;
				            }
				
				            card.innerHTML = `
				                <div class="flex justify-between items-start">
				                    <div>
				                        <p class="font-bold text-white">${comment.author_name} <span class="text-xs font-normal ${comment.is_approved ? 'text-green-400' : 'text-amber-400'}">(${comment.is_approved ? 'Disetujui' : 'Menunggu'})</span></p>
				                        <p class="text-sm text-slate-300 mt-2 break-words">${comment.content}</p>
				                    </div>
				                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 flex-shrink-0 ml-4">
				                        ${actionButtons}
				                    </div>
				                </div>
				                <div class="mt-3 pt-3 border-t border-white/10 text-xs text-slate-400">
				                    Pada: <a href="/post.html?slug=${comment.posts.slug}" target="_blank" class="text-indigo-400 hover:underline">${comment.posts.title || 'Tanpa Judul'}</a>
				                </div>
				                <div id="reply-form-container-${comment.id}" class="mt-4"></div>`;
				            listContainer.appendChild(card);
				        });
				
				        const totalPages = Math.ceil(totalComments / commentsPerPage);
				        pageInfo.textContent = `Halaman ${currentPage} dari ${totalPages}`;
				        
				        prevPageBtn.disabled = currentPage === 1;
				        nextPageBtn.disabled = currentPage >= totalPages;
				
				        if (totalPages > 1) {
				            paginationControls.classList.remove('hidden');
				        }
				    }

					searchForm.addEventListener('submit', (e) => {
       					 e.preventDefault();
						const searchTerm = searchInput.value.trim();
						if (searchTerm !== currentSearchTerm) {
							currentSearchTerm = searchTerm;
							currentPage = 1;
							loadComments(currentPage, currentFilter, currentSearchTerm);
						}
					});
				
				    tabsContainer.addEventListener('click', (e) => {
				        const button = e.target.closest('button');
				        if (button && button.dataset.filter !== currentFilter) {
				            currentFilter = button.dataset.filter;
				            currentPage = 1;
				            document.querySelector('.comment-tab-btn.active').classList.remove('active');
				            button.classList.add('active');
				            loadComments(currentPage, currentFilter);
				        }
				    });
				
				    prevPageBtn.addEventListener('click', () => {
        				if (currentPage > 1) {
            				currentPage--;
            				loadComments(currentPage, currentFilter, currentSearchTerm);
        					}
    				});
				
				    nextPageBtn.addEventListener('click', () => {
        				currentPage++;
        				loadComments(currentPage, currentFilter, currentSearchTerm);
    				});
				
				    tabsContainer.querySelector('[data-filter="pending"]').classList.add('active');
    				await loadComments(currentPage, currentFilter, currentSearchTerm);
				}

				window.approveComment = async (commentId) => {
	    			const { error } = await supabase.from('comments').update({ is_approved: true }).eq('id', commentId);
	    			if (error) {
    					showToast('Gagal menyetujui: ' + error.message, 'error', error);
					} else {
	    				showToast('Komentar berhasil disetujui!');
					}
				}
	
	            window.deleteComment = (commentId) => {
	    			showConfirmationModal(async () => {
	        			const { error } = await supabase.from('comments').delete().eq('id', commentId);
	        			if (error) {
    						showToast('Gagal menghapus: ' + error.message, 'error', error);
						} else {
	    					showToast('Komentar berhasil dihapus!');
						}
	    			});
				}
				window.replyToComment = async (parentCommentId, postId) => {
	    			const existingForm = document.getElementById('active-reply-form');
	    				if (existingForm) {
	        				existingForm.remove();
	    				}
	
	    				const container = document.getElementById(`reply-form-container-${parentCommentId}`);
	    				if (!container) return;
	
				    	const formHTML = `
				        	<form id="active-reply-form" class="space-y-3 glass-card p-3 rounded-lg border-indigo-400/50">
				            	<textarea id="reply-textarea" class="w-full bg-neutral-900/50 p-2 rounded-md text-slate-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-400" rows="3" placeholder="Tulis balasan Anda sebagai Admin..."></textarea>
				            	<div class="flex justify-end space-x-2">
				                	<button type="button" id="cancel-reply-btn" class="text-xs font-semibold py-1 px-3 rounded-full hover:bg-neutral-700">Batal</button>
				                	<button type="submit" class="bg-indigo-500 text-white text-xs font-bold py-1 px-3 rounded-full hover:bg-indigo-600">Kirim Balasan</button>
				            	</div>
				        	</form>`;
	
	    				container.innerHTML = formHTML;
	    				document.getElementById('reply-textarea').focus();
	    
	    				document.getElementById('active-reply-form').addEventListener('submit', async (e) => {
	        				e.preventDefault();
	        				const replyContent = document.getElementById('reply-textarea').value;
	        				const submitButton = e.target.querySelector('button[type="submit"]');
	
	        				if (replyContent && replyContent.trim() !== "") {
	            				submitButton.disabled = true;
	            				submitButton.textContent = 'Mengirim...';
	
	            				const { data: { user } } = await supabase.auth.getUser();
	            				const adminName = user.email.split('@')[0] + " (Admin)";
	
	            				const { error } = await supabase.from('comments').insert({
	                				post_id: postId,
	                				parent_id: parentCommentId,
	                				content: replyContent,
	                				author_name: adminName,
	                				is_approved: true,
	                				user_id: user.id
	            				});
	
	            				if (error) {
    								showToast("Gagal mengirim balasan: " + error.message, 'error', error);
	                				submitButton.disabled = false;
	                				submitButton.textContent = 'Kirim Balasan';
	            				} else {
	            					showToast("Balasan berhasil dikirim!");
									document.getElementById('active-reply-form').remove();
	               				await supabase.from('comments').update({ is_approved: true }).eq('id', parentCommentId);
	            				}
	        				}
	    				});
	
	    				document.getElementById('cancel-reply-btn').addEventListener('click', () => {
	        			document.getElementById('active-reply-form').remove();
	    			});
				}
	
				async function checkPendingComments() {
	                const { count } = await supabase.from('comments').select('id', { count: 'exact', head: true }).eq('is_approved', false);
	                if (count > 0) { commentBadge.textContent = count > 9 ? '9+' : count; commentBadge.classList.remove('hidden'); } 
	                else { commentBadge.classList.add('hidden'); }
	            }
	            
	            function listenForCommentChanges() {
	                console.log('Realtime listener untuk komentar diaktifkan.');
	                supabase.channel('public:comments')
	                    .on(
	                        'postgres_changes',
	                        { event: '*', schema: 'public', table: 'comments' },
	                        (payload) => {
	                            console.log('Perubahan terdeteksi pada tabel komentar!', payload);
	                            checkPendingComments(); 
	                            
	                            const isOnCommentView = document.getElementById('comments-list');
	                            if (isOnCommentView) {
	                                console.log('Merefresh daftar komentar...');
	                                renderView('comments');
	                            }
	                        }
	                    )
	                    .subscribe((status) => {
	                        if (status === 'SUBSCRIBED') {
	                            console.log('Berhasil terhubung ke channel realtime Supabase!');
	                        }
	                    });
	            }

	            // --- FUNGSI VIEW: STATISTIK ---
	            async function renderStatsView() {
				    let currentRange = 30;
				
				    const dateFilterButtons = document.getElementById('date-filter-buttons');
				    const monthlyViewsContainer = document.querySelector('#monthlyViewsChart').parentElement;
				    const categoryChartContainer = document.querySelector('#postsByCategoryChart').parentElement;
				    const topPostsListContainer = document.getElementById('topPostsList');
				
					async function loadStatsForRange(days) {
						document.querySelector('#monthlyViewsChart').parentElement.parentElement.innerHTML = '<div class="h-80 skeleton-pulse"></div>'; // Target div pembungkus
						const categoryChartContainer = document.querySelector('#postsByCategoryChart').parentElement;
						if(categoryChartContainer) categoryChartContainer.innerHTML = '<canvas id="postsByCategoryChart"></canvas>';
						
						const tableBody = document.querySelector('#posts-performance-table tbody');
						if (tableBody) tableBody.innerHTML = `<tr><td colspan="3">${getActivityLogSkeletonHTML()}</td></tr>`;

						

						let startDate = new Date('1970-01-01');
						if (days !== 'all') {
							startDate = new Date();
							startDate.setDate(startDate.getDate() - days);
						}
						
						const [postsRes, commentsRes] = await Promise.all([
							supabase.from('posts').select('id, title, views, category, created_at').gte('created_at', startDate.toISOString()),
							supabase.from('comments').select('post_id').gte('created_at', startDate.toISOString())
						]);

						document.querySelector('.glass-card .skeleton-pulse').parentElement.innerHTML = '<h2 class="text-lg font-semibold text-white mb-4">Tren Views Harian</h2><div class="h-80"><canvas id="monthlyViewsChart"></canvas></div>';
						if(categoryChartContainer) categoryChartContainer.innerHTML = '<canvas id="postsByCategoryChart"></canvas>';
						if (tableBody) tableBody.innerHTML = '';
						
						if (postsRes.error || commentsRes.error) {
							if(tableBody) tableBody.innerHTML = '<tr><td colspan="3" class="text-red-400 text-center p-4">Gagal memuat data.</td></tr>';
							return;
						}

						const commentsCount = commentsRes.data.reduce((acc, comment) => {
							acc[comment.post_id] = (acc[comment.post_id] || 0) + 1;
							return acc;
						}, {});

						const postsWithStats = postsRes.data.map(post => ({
							...post,
							comment_count: commentsCount[post.id] || 0
						}));

						const dailyViews = postsWithStats.reduce((acc, p) => {
							if (p.views > 0) {
								const date = new Date(p.created_at).toISOString().split('T')[0];
								acc[date] = (acc[date] || 0) + p.views;
							}
							return acc;
						}, {});
						const sortedDailyViews = Object.entries(dailyViews).sort((a, b) => new Date(a[0]) - new Date(b[0]));
						createChart('monthlyViewsChart', 'line', sortedDailyViews.map(e => new Date(e[0]).toLocaleDateString('id-ID', { month: 'short', day: 'numeric' })), sortedDailyViews.map(e => e[1]), 'Total Views');

						const postsByCategory = postsWithStats.reduce((acc, p) => {
							const category = p.category || 'Lainnya';
							acc[category] = (acc[category] || 0) + 1;
							return acc;
						}, {});
						createChart('postsByCategoryChart', 'bar', Object.keys(postsByCategory), Object.values(postsByCategory), 'Jumlah Post');
						
						if (postsWithStats.length > 0) {
							postsWithStats.sort((a, b) => (b.views || 0) - (a.views || 0));

							postsWithStats.forEach(p => {
								const row = `
									<tr class="hover:bg-white/5">
										<td class="py-3 px-4 font-medium text-white">${p.title}</td>
										<td class="py-3 px-4">${p.views || 0}</td>
										<td class="py-3 px-4">${p.comment_count}</td>
									</tr>
								`;
								if (tableBody) tableBody.innerHTML += row;
							});
						} else {
							if (tableBody) tableBody.innerHTML = '<tr><td colspan="3" class="text-slate-500 text-center p-4">Tidak ada data postingan untuk periode ini.</td></tr>';
						}
					}
				
				    dateFilterButtons.addEventListener('click', (e) => {
				        const button = e.target.closest('button');
				        if (button) {
				            const range = button.dataset.range === 'all' ? 'all' : parseInt(button.dataset.range, 10);
				            if(range !== currentRange) {
				                currentRange = range;
				                
				                document.querySelector('.date-filter-btn.active').classList.remove('active');
				                button.classList.add('active');
				                
				                loadStatsForRange(currentRange);
				            }
				        }
				    });
				
				    if (!document.querySelector('style#dynamic-styles')) {
				        const style = document.createElement('style');
				        style.id = 'dynamic-styles';
				        style.innerHTML = `.date-filter-btn.active { background-color: #818cf8; color: #fff; }`;
				        document.head.appendChild(style);
				    }
				    
				    await loadStatsForRange(currentRange);
				}
	            
	            function createChart(canvasId, type, labels, data, label, bgColors = ['rgba(99, 102, 241, 0.6)']) {
				    const chartEl = document.getElementById(canvasId);
				    if (!chartEl) return;
				    if (charts[canvasId]) charts[canvasId].destroy();
				
				    let chartBackgroundColor = bgColors;
				    let fill = type !== 'line';
				    if (type === 'line') {
				        fill = true;
				        chartBackgroundColor = 'rgba(99, 102, 241, 0.2)';
				    }
				
				    const chartOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { ticks: { color: '#a3a3a3' } }, y: { ticks: { color: '#a3a3a3' }, beginAtZero: true } }};
				    if (type === 'doughnut' || type === 'pie') {
				        chartOptions.scales = {};
				        chartOptions.plugins.legend = { display: true, position: 'bottom', labels: { color: '#a3a3a3' } };
				        chartBackgroundColor = ['#22c55e', '#f59e0b', '#818cf8', '#ef4444', '#f97316'];
				    }
				
				    charts[canvasId] = new Chart(chartEl.getContext('2d'), {
				        type,
				        data: {
				            labels,
				            datasets: [{
				                label,
				                data,
				                backgroundColor: chartBackgroundColor,
				                borderColor: '#818cf8',
				                tension: 0.3,
				                fill: fill
				            }]
				        },
				        options: chartOptions
				    });
				}
	            
	        	function showConfirmationModal(onConfirm) {
	            	confirmationModal.classList.remove('hidden');
	            
	            	const newConfirmBtn = confirmDeleteBtn.cloneNode(true);
	            	confirmDeleteBtn.parentNode.replaceChild(newConfirmBtn, confirmDeleteBtn);
	            
	            	newConfirmBtn.addEventListener('click', () => {
	                	onConfirm();
	                	hideConfirmationModal();
	            	});
	       		}
	
	        	function hideConfirmationModal() {
	            	confirmationModal.classList.add('hidden');
	        	}
	        
	        	async function showToast(message, type = 'success', errorObject = null) {
                const toastContainer = document.getElementById('toast-container');
                if (!toastContainer) {
                    console.warn("Toast container not found. Messages will only appear in console.");
                    console.log(`Toast: ${type.toUpperCase()} - ${message}`, errorObject);
                    return;
                }

                const toast = document.createElement('div');
                const icon = type === 'success' ? '<i class="ri-checkbox-circle-fill"></i>' : '<i class="ri-error-warning-fill"></i>';

                const baseClasses = 'flex items-center space-x-3 text-white text-sm font-semibold p-3 rounded-xl shadow-lg toast-message transition-all duration-300 transform translate-x-full animate-slide-in';
                const typeClass = type === 'success' ? 'toast-success' : 'toast-error';
                

                toast.className = `${baseClasses} ${typeClass}`;

                toast.innerHTML = `<span>${icon}</span><p>${message}</p>`;
                toastContainer.appendChild(toast);

                if (type === 'error' && errorObject) {
                    console.error("Mencatat error ke database:", errorObject);
                    const { data: { user } } = await supabase.auth.getUser();
                    supabase.from('error_logs').insert({
                        error_message: errorObject.message,
                        error_details: { code: errorObject.code, details: errorObject.details, hint: errorObject.hint },
                        location: "Client-Side Admin Dashboard",
                        user_id: user?.id,
                        user_email: user?.email
                    }).then(() => console.log('Error logged.'));
                }

                setTimeout(() => {
                    toast.classList.remove('animate-slide-in');
                    toast.classList.add('opacity-0');
                 }, 4000);
                 setTimeout(() => {
                    toast.remove();
                    }, 4000 + 350);
            }

	            
	            function getCommentSkeletonHTML() {
	                let skeletonHTML = '<div class="space-y-4">';
	                for (let i = 0; i < 3; i++) {
	                    skeletonHTML += '<div class="w-full h-28 skeleton-pulse"></div>';
	                }
	                skeletonHTML += '</div>';
	                return skeletonHTML;
	            }
	            
	            function getPopularPostsSkeletonHTML() {
	                let skeletonHTML = '<div class="space-y-3">';
	                for (let i = 0; i < 4; i++) {
	                    skeletonHTML += '<div class="w-full h-12 skeleton-pulse"></div>';
	                }
	                skeletonHTML += '</div>';
	                return skeletonHTML;
	            }
	            
	            function getStatsSkeletonHTML() {
	                return `
	                    <div class="space-y-8">
	                        <div class="glass-card p-6 rounded-2xl">
	                            <h2 class="text-lg font-semibold text-white mb-4">Total Views per Bulan</h2>
	                            <div class="h-80 skeleton-pulse"></div>
	                        </div>
	                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
	                            <div class="glass-card p-6 rounded-2xl">
	                                <h2 class="text-lg font-semibold text-white mb-4">Post per Kategori</h2>
	                                <div class="h-80 skeleton-pulse"></div>
	                            </div>
	                            <div class="glass-card p-6 rounded-2xl">
	                                <h2 class="text-lg font-semibold text-white mb-4">Top 5 Postingan</h2>
	                                <div class="space-y-3">
	                                    <div class="h-10 w-full skeleton-pulse"></div>
	                                    <div class="h-10 w-full skeleton-pulse"></div>
	                                    <div class="h-10 w-full skeleton-pulse"></div>
	                                    <div class="h-10 w-full skeleton-pulse"></div>
	                                    <div class="h-10 w-full skeleton-pulse"></div>
	                                </div>
	                            </div>
	                        </div>
	                    </div>
	                `;
	            }
	            
	            async function renderRecentActivity() {
	    			const listContainer = document.getElementById('recentActivityList');
	    			if (!listContainer) return;
	
	    			listContainer.innerHTML = `
	        			<div class="space-y-3">
	            			<div class="h-14 w-full skeleton-pulse"></div>
	            			<div class="h-14 w-full skeleton-pulse"></div>
	            			<div class="h-14 w-full skeleton-pulse"></div>
	            			<div class="h-14 w-full skeleton-pulse"></div>
	        			</div>
	    			`;
	
	    			const [recentCommentsRes, recentPostsRes] = await Promise.all([
	        			supabase.from('comments').select('id, content, author_name, created_at, posts(title)')
	            		.order('created_at', { ascending: false }).limit(5),
	        			supabase.from('posts').select('id, title, created_at, published')
	            		.order('created_at', { ascending: false }).limit(5)
	    			]);
	
	    			let activities = [];
	
	    			if (!recentCommentsRes.error) {
	        			recentCommentsRes.data.forEach(item => {
	            			activities.push({
	                			type: 'comment',
	                			content: `Komentar dari <strong>${item.author_name}</strong> di "${item.posts.title}"`,
	                			date: new Date(item.created_at)
	            			});
	        			});
	    			}
	
	    			if (!recentPostsRes.error) {
	        			recentPostsRes.data.forEach(item => {
	            			activities.push({
	                			type: 'post',
	                			content: `Postingan <strong>"${item.title}"</strong> telah ${item.published ? 'dipublikasikan' : 'dibuat (draft)'}.`,
	                			date: new Date(item.created_at)
	            			});
	        			});
	    			}
	
	    			activities.sort((a, b) => b.date - a.date);
	
	    			const latestActivities = activities.slice(0, 5);
	    
	    			if (latestActivities.length > 0) {
	        			listContainer.innerHTML = '';
	        			latestActivities.forEach(item => {
	            			const icon = item.type === 'comment' 
	                		? '<i class="ri-chat-4-line text-indigo-400"></i>'
	                		: '<i class="ri-file-text-line text-green-400"></i>';
	
	            		listContainer.innerHTML += `
	                		<div class="glass-card p-3 rounded-xl flex items-start space-x-3 text-sm">
	                    		<div class="flex-shrink-0 mt-1">${icon}</div>
	                    		<div>
	                        		<p class="text-slate-200">${item.content}</p>
	                        		<p class="text-xs text-slate-400 mt-1">${item.date.toLocaleString('id-ID', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' })}</p>
	                    		</div>
	                		</div>
	            		`;
	        		});
	    			} else {
	       	 			listContainer.innerHTML = '<p class="text-sm text-slate-500 text-center p-4">Belum ada aktivitas.</p>';
	    			}
				}

				function getActivityLogSkeletonHTML() {
				    let skeletonHTML = '<div class="space-y-4">';
				    for (let i = 0; i < 5; i++) {
				        skeletonHTML += '<div class="w-full h-16 skeleton-pulse"></div>';
				    }
				    skeletonHTML += '</div>';
				    return skeletonHTML;
				}
				
				async function loadActivityLogs(page = 1) {
				    const logsPerPage = 10;
				    const container = document.getElementById('tab-content-activity');
				    container.innerHTML = getActivityLogSkeletonHTML();
				
				    const from = (page - 1) * logsPerPage;
				    const to = from + logsPerPage - 1;
				
				    const { data: logs, error, count: totalLogs } = await supabase.from('activity_logs')
				        .select('*', { count: 'exact' })
				        .order('created_at', { ascending: false })
				        .range(from, to);
				    
				    if (error) {
				        container.innerHTML = '<p class="text-red-400 text-center">Gagal memuat log aktivitas.</p>';
				        return;
				    }
				    if (logs.length === 0) {
				        container.innerHTML = '<p class="text-center text-slate-500 p-8">👍 Belum ada aktivitas yang tercatat.</p>';
				        return;
				    }
				
				    container.innerHTML = '';
				    logs.forEach(log => {
				        let icon = '<i class="ri-question-mark-line text-slate-400"></i>';
				        let actionText = `Aksi tidak dikenal: ${log.action}`;
				
				        if (log.action === 'APPROVED_COMMENT') {
				            icon = '<i class="ri-check-double-line text-green-400"></i>';
				            actionText = `Anda menyetujui komentar dari <strong>${log.details.author_name}</strong> di "${log.details.post_title || 'postingan'}"`;
				        } else if (log.action === 'DELETE_COMMENT') {
				            icon = '<i class="ri-chat-delete-line text-red-400"></i>';
				            actionText = `Anda menghapus komentar dari <strong>${log.details.author_name}</strong> di "${log.details.post_title || 'postingan'}"`;
				        } else if (log.action === 'CREATE_POST') {
                            icon = '<i class="ri-file-add-line text-indigo-400"></i>';
                            actionText = `Anda membuat postingan baru: <strong>"${log.details.title}"</strong>`;
                        } else if (log.action === 'UPDATE_POST') {
                            icon = '<i class="ri-file-edit-line text-blue-400"></i>';
                            actionText = `Anda memperbarui postingan: <strong>"${log.details.title}"</strong>`;
                        } else if (log.action === 'DELETE_POST') {
                            icon = '<i class="ri-file-forbid-line text-red-400"></i>';
                            actionText = `Anda menghapus postingan: <strong>"${log.details.title || log.details.postId}"</strong>`;
                        } else if (log.action === 'ADD_CATEGORY') {
                            icon = '<i class="ri-folder-add-line text-purple-400"></i>';
                            actionText = `Anda menambahkan kategori baru: <strong>"${log.details.name}"</strong>`;
                        } else if (log.action === 'UPDATE_CATEGORY') {
                            icon = '<i class="ri-folder-edit-line text-orange-400"></i>';
                            actionText = `Anda memperbarui kategori: <strong>"${log.details.newName}"</strong>`;
                        } else if (log.action === 'DELETE_CATEGORY') {
                            icon = '<i class="ri-folder-reduce-line text-red-400"></i>';
                            actionText = `Anda menghapus kategori: <strong>"${log.details.name || log.details.categoryId}"</strong>`;
                        } else if (log.action === 'ADD_MUSIC_RELEASE') {
                            icon = '<i class="ri-music-fill text-green-400"></i>';
                            actionText = `Anda menambahkan rilisan musik: <strong>"${log.details.title}"</strong>`;
                        } else if (log.action === 'UPDATE_MUSIC_RELEASE') {
                            icon = '<i class="ri-album-line text-blue-400"></i>';
                            actionText = `Anda memperbarui rilisan musik: <strong>"${log.details.title}"</strong>`;
                        } else if (log.action === 'DELETE_MUSIC_RELEASE') {
                            icon = '<i class="ri-album-line text-red-400"></i>';
                            actionText = `Anda menghapus rilisan musik: <strong>"${log.details.title || log.details.musicId}"</strong>`;
                        } else if (log.action === 'ADD_AFFILIATE_LINK') {
                            icon = '<i class="ri-link-m text-purple-400"></i>';
                            actionText = `Anda menambahkan link afiliasi: <strong>"${log.details.name}"</strong>`;
                        } else if (log.action === 'UPDATE_AFFILIATE_LINK') {
                            icon = '<i class="ri-link-m text-orange-400"></i>';
                            actionText = `Anda memperbarui link afiliasi: <strong>"${log.details.name}"</strong>`;
                        } else if (log.action === 'DELETE_AFFILIATE_LINK') {
                            icon = '<i class="ri-link-unlink-m text-red-400"></i>';
                            actionText = `Anda menghapus link afiliasi: <strong>"${log.details.name || log.details.affiliateId}"</strong>`;
                        } else if (log.action === 'UPDATE_PROFILE') {
                            icon = '<i class="ri-user-settings-line text-teal-400"></i>';
                            actionText = `Anda memperbarui profil Anda.`;
                        } else if (log.action === 'CHANGE_PASSWORD') {
                            icon = '<i class="ri-lock-2-line text-yellow-400"></i>';
                            actionText = `Anda mengubah password Anda.`;
                        }	else if (log.action === 'UPDATE_SCHEDULED_POST') {
    						icon = '<i class="ri-calendar-schedule-line text-cyan-400"></i>'; 
    						actionText = `Anda memperbarui postingan terjadwal: <strong>"${log.details.title}"</strong>`;
						}
				
				        container.innerHTML += `
				            <div class="glass-card p-3 rounded-xl flex items-start space-x-4 text-sm">
				                <div class="flex-shrink-0 mt-1 text-xl">${icon}</div>
				                <div>
				                    <p class="text-slate-200">${actionText}</p>
				                    <p class="text-xs text-slate-400 mt-1">${new Date(log.created_at).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</p>
				                </div>
				            </div>
				        `;
				    });
				// Di sini kita bisa menambahkan logika paginasi untuk log jika diperlukan di masa depan
				}

								async function loadErrorLogs(page = 1) {
				    const logsPerPage = 15;
				    const container = document.getElementById('tab-content-error');
				    container.innerHTML = getActivityLogSkeletonHTML(); // Gunakan skeleton loading

				    const from = (page - 1) * logsPerPage;
				    const to = from + logsPerPage - 1;

				    const { data: logs, error, count: totalLogs } = await supabase.from('error_logs')
				        .select('*', { count: 'exact' })
				        .order('created_at', { ascending: false })
				        .range(from, to);
				    
				    if (error) {
				        container.innerHTML = '<p class="text-red-400 text-center">Gagal memuat log error.</p>';
				        // Tidak perlu showToast di sini karena sudah ada di showToast yang memicu log ini
				        return;
				    }
				    if (logs.length === 0) {
				        container.innerHTML = '<p class="text-center text-slate-500 p-8"><i class="ri-check-line mr-2"></i>Tidak ada error yang tercatat. Sistem bersih!</p>';
				        return;
				    }

				    container.innerHTML = '';
				    logs.forEach(log => {
				        // Format detail error agar lebih mudah dibaca, bisa custom tergantung struktur error_details
				        let formattedDetails = '';
				        if (log.error_details) {
				            try {
				                const details = log.error_details; // Sudah JSONB, jadi sudah objek
				                if (details.code) formattedDetails += `<strong>Code:</strong> ${details.code}<br>`;
				                if (details.details) formattedDetails += `<strong>Details:</strong> ${details.details}<br>`;
				                if (details.hint) formattedDetails += `<strong>Hint:</strong> ${details.hint}<br>`;
				                // Jika ada property lain yang ingin ditampilkan
				                if (details.message && !details.details) formattedDetails += `<strong>Message:</strong> ${details.message}<br>`; // Jika message terpisah dari details
				                if (details.location) formattedDetails += `<strong>Source:</strong> ${details.location}<br>`; // Jika location ada di details
				                
				                // Jika masih ada data JSON yang kompleks, tampilkan dalam <pre>
				                const remainingDetails = { ...details };
				                delete remainingDetails.code;
				                delete remainingDetails.details;
				                delete remainingDetails.hint;
				                delete remainingDetails.message;
				                delete remainingDetails.location; // Hapus yang sudah ditampilkan

				                if (Object.keys(remainingDetails).length > 0) {
				                    formattedDetails += `<details class="mt-2 text-xs text-slate-400"><summary>Lihat Detail JSON Lengkap</summary><pre class="whitespace-pre-wrap p-2 bg-neutral-900/50 rounded-md font-mono">${JSON.stringify(remainingDetails, null, 2)}</pre></details>`;
				                }
				            } catch (e) {
				                console.error("Error parsing error_details:", e);
				                formattedDetails = `<pre class="whitespace-pre-wrap">${JSON.stringify(log.error_details, null, 2)}</pre>`; // Fallback ke JSON mentah
				            }
				        } else {
				            formattedDetails = '<i>Tidak ada detail error.</i>';
				        }

				        container.innerHTML += `
				            <div class="glass-card p-4 rounded-xl text-sm break-words">
				                <div class="flex justify-between items-start mb-2">
				                    <div>
				                        <p class="font-bold text-red-400"><i class="ri-bug-line mr-2"></i>${log.error_message || 'Error tidak diketahui'}</p>
				                        <p class="text-xs text-slate-500 mt-1">Dicatat dari: ${log.user_email || 'Tidak Diketahui'} di ${log.location || 'Client-Side'}</p>
				                    </div>
				                    <p class="text-xs text-slate-400 flex-shrink-0 ml-4">${new Date(log.created_at).toLocaleString('id-ID', { dateStyle: 'medium', timeStyle: 'short' })}</p>
				                </div>
				                <div class="text-xs text-slate-300">
				                    ${formattedDetails}
				                </div>
				            </div>
				        `;
				    });
				    // Di sini kita bisa menambahkan logika paginasi untuk log jika diperlukan di masa depan
				}
				
				async function renderSettingsView() {
					const { data: { user } } = await supabase.auth.getUser();
					
					const settingsUsername = document.getElementById('settings-username');
					const settingsEmail = document.getElementById('settings-email');
					const settingsAvatar = document.getElementById('settings-avatar');
					const editNameInput = document.getElementById('edit-name-input');
					const editNameBtn = document.getElementById('edit-name-btn');
					const editNameActions = document.getElementById('edit-name-actions');
					const cancelEditNameBtn = document.getElementById('cancel-edit-name-btn');
					const saveNameBtn = document.getElementById('save-name-btn');
					const changeAvatarBtn = document.getElementById('change-avatar-btn');
					const avatarUploadInput = document.getElementById('avatar-upload-input');
					const headerAvatarImg = document.getElementById('user-avatar-img');
					const settingsAvatarImg = document.getElementById('settings-avatar');
					const changePasswordBtn = document.getElementById('change-password-btn');
					const changePasswordModal = document.getElementById('change-password-modal');

					let currentUser = user;
					let currentName = '';

					changeAvatarBtn.addEventListener('click', () => {
    					avatarUploadInput.click();
					});

					
					avatarUploadInput.addEventListener('change', async (e) => {
						const file = e.target.files[0];
						if (!file) return;

						console.log("1. File dipilih:", file.name);

						const maxSize = 2 * 1024 * 1024;
						if (file.size > maxSize) {
							showToast('Ukuran file terlalu besar (maks 2MB).', 'error');
							return;
						}

						changeAvatarBtn.disabled = true;
						changeAvatarBtn.textContent = 'Mengupload...';

						const fileExt = file.name.split('.').pop();
						const filePath = `${currentUser.id}/${Date.now()}.${fileExt}`;

						try {
							const { data: uploadData, error: uploadError } = await supabase.storage
								.from('avatars')
								.upload(filePath, file, { upsert: true });
							if (uploadError) throw uploadError;
							console.log("2. Upload ke Storage SUKSES.");

							const { data: urlData } = supabase.storage
								.from('avatars')
								.getPublicUrl(filePath);
							console.log("3. Hasil getPublicUrl():", urlData);
							
							const publicUrl = urlData.publicUrl;
							if (!publicUrl) {
								throw new Error("URL Publik tidak ditemukan setelah upload. Cek policy SELECT di bucket Anda.");
							}

							const { data: updateUserResponse, error: updateError } = await supabase.auth.updateUser({
								data: { avatar_url: publicUrl }
							});
							if (updateError) throw updateError;
							console.log("4. Update metadata user SUKSES.");

							const updatedAvatarUrl = updateUserResponse.user.user_metadata.avatar_url;
							console.log("5. Mencoba menampilkan gambar dari URL:", updatedAvatarUrl);
							
							headerAvatarImg.src = updatedAvatarUrl;
							settingsAvatarImg.src = updatedAvatarUrl;
							showToast('Foto profil berhasil diperbarui!');
							console.log("6. UI berhasil di-update.");

						} catch (error) {
							console.error("Terjadi error di tengah proses:", error);
							showToast('Gagal mengubah foto profil.', 'error', error);
						} finally {
							changeAvatarBtn.disabled = false;
							changeAvatarBtn.textContent = 'Ubah Foto';
							avatarUploadInput.value = '';
						}
					});

					if (currentUser) {
						currentName = currentUser.user_metadata.full_name || currentUser.email.split('@')[0];
						settingsUsername.textContent = currentName;
						settingsEmail.textContent = currentUser.email;
						
						const settingsAvatar = document.getElementById('settings-avatar');
						if (settingsAvatar && currentUser.user_metadata.avatar_url) {
							settingsAvatar.src = currentUser.user_metadata.avatar_url;
						}
					}

					function toggleNameEditMode(isEditing) {
						if (isEditing) {
							settingsUsername.classList.add('hidden');
							editNameBtn.classList.add('hidden');
							editNameInput.classList.remove('hidden');
							editNameActions.classList.remove('hidden');
							editNameInput.value = currentName;
							editNameInput.focus();
						} else {
							settingsUsername.classList.remove('hidden');
							editNameBtn.classList.remove('hidden');
							editNameInput.classList.add('hidden');
							editNameActions.classList.add('hidden');
						}
					}

					editNameBtn.addEventListener('click', () => {
						toggleNameEditMode(true);
					});

					cancelEditNameBtn.addEventListener('click', () => {
						toggleNameEditMode(false);
					});

					saveNameBtn.addEventListener('click', async () => {
						const newName = editNameInput.value.trim();
						
						if (!newName || newName === currentName) {
							toggleNameEditMode(false);
							return;
						}

						saveNameBtn.disabled = true;
						saveNameBtn.textContent = 'Menyimpan...';

						const { data: updatedUser, error } = await supabase.auth.updateUser({
							data: { full_name: newName }
						});

						if (error) {
							showToast('Gagal memperbarui nama.', 'error', error);
						} else {
							showToast('Nama berhasil diperbarui!');
							currentName = updatedUser.user.user_metadata.full_name;
							settingsUsername.textContent = currentName;
							document.getElementById('user-name-header').textContent = currentName;
							toggleNameEditMode(false);
						}

						saveNameBtn.disabled = false;
						saveNameBtn.textContent = 'Simpan';
					});
					
					changePasswordBtn.addEventListener('click', () => {
    					changePasswordModal.classList.remove('hidden');
					});

				    const tabsContainer = document.getElementById('settings-tabs');
				    const tabButtons = tabsContainer.querySelectorAll('.settings-tab-btn');
				    const tabContents = document.querySelectorAll('.tab-content');
				    let activityLogLoaded = false;
					let errorLogLoaded = false;
				
				    tabsContainer.addEventListener('click', (e) => {
				        const button = e.target.closest('button');
				        if (!button) return;
				
				        const tabToActivate = button.dataset.tab;
				
				        tabButtons.forEach(btn => {
				            btn.classList.remove('active');
				            btn.classList.add('text-gray-400');
				        });
				        button.classList.add('active');
				        button.classList.remove('text-gray-400');
				
				        tabContents.forEach(content => {
				            if (content.id === `tab-content-${tabToActivate}`) {
				                content.classList.remove('hidden');
				            } else {
				                content.classList.add('hidden');
				            }
				        });
				
				        if (tabToActivate === 'activity' && !activityLogLoaded) {
				            loadActivityLogs();
				            activityLogLoaded = true;
				        }
						
						if (tabToActivate === 'error' && !errorLogLoaded) {
            				loadErrorLogs();
            				errorLogLoaded = true;
        				}
				    });
				}
				function initializePresenceListener() {
    				console.log("Menginisialisasi listener untuk Presence...");
    				const liveCountElement = document.getElementById('live-count');
    				const liveDotElement = document.getElementById('live-dot');

					const channel = supabase.channel('live-visitors');

					channel.on('presence', { event: 'sync' }, () => {
						const presences = channel.presenceState();
						const count = Object.keys(presences).length;
						
						console.log('Data presence disinkronkan, jumlah pengunjung:', count);
						liveCountElement.textContent = `${count} Pengunjung`;
		
						if(count > 0) {
							liveDotElement.classList.add('blinking-dot');
						} else {
							liveDotElement.classList.remove('blinking-dot');
						}
					});

					channel.subscribe(async (status) => {
						if (status === 'SUBSCRIBED') {
							console.log('Berhasil terhubung ke channel Presence.');
							await channel.track({ online_at: new Date().toISOString() });
							return;
						}
					});
				}

	            async function initializePage() {
				    const { data: { session } } = await supabase.auth.getSession();
				    if (!session) {
				        window.location.replace('login.html');
				        return;
				    }
				    
				    const { data: { user } } = await supabase.auth.getUser();
				    if (user) {
				        const userNameElement = document.getElementById('user-name-header');
				        if (userNameElement) {
				            userNameElement.textContent = user.user_metadata.full_name || user.email.split('@')[0];
				        }
				
						const headerAvatarImg = document.getElementById('user-avatar-img');
						if (headerAvatarImg && user.user_metadata.avatar_url) {
							headerAvatarImg.src = user.user_metadata.avatar_url;
						}
				        
				        const avatarButton = document.getElementById('avatar-button');
				        const dropdown = document.getElementById('profile-dropdown');
				        const logoutBtn = document.getElementById('logout-btn-dropdown');
				        
				        avatarButton.addEventListener('click', (e) => {
				            e.stopPropagation();
				            dropdown.classList.toggle('hidden');
				        });
				
				        logoutBtn.addEventListener('click', async (e) => {
				            e.preventDefault();
				            await supabase.auth.signOut();
				            window.location.replace('login.html');
				        });
				    }
				    
				    window.addEventListener('click', () => {
				        const dropdown = document.getElementById('profile-dropdown');
				        if (dropdown && !dropdown.classList.contains('hidden')) {
				            dropdown.classList.add('hidden');
				        }
				    });
				
				    app.classList.remove('opacity-0');
				
				    navItems.forEach(item => {
				        item.addEventListener('click', (e) => {
				            const view = e.currentTarget.dataset.view;
				            if (view) renderView(view);
				        });
				    });
				    
				    cancelDeleteBtn.addEventListener('click', hideConfirmationModal);
				    confirmationModal.addEventListener('click', (e) => {
				        if (e.target === confirmationModal) {
				            hideConfirmationModal();
				        }
				    });

					const changePasswordModal = document.getElementById('change-password-modal');
					const cancelPasswordChangeBtn = document.getElementById('cancel-password-change-btn');
					const changePasswordForm = document.getElementById('change-password-form');

					cancelPasswordChangeBtn.addEventListener('click', () => {
						changePasswordModal.classList.add('hidden');
						changePasswordForm.reset();
					});

					changePasswordForm.addEventListener('submit', async (e) => {
						e.preventDefault();
						const newPassword = document.getElementById('new-password').value;
						const confirmPassword = document.getElementById('confirm-password').value;
						const saveBtn = document.getElementById('save-password-change-btn');

						if (newPassword.length < 6) {
							showToast('Password baru harus minimal 6 karakter.', 'error');
							return;
						}
						if (newPassword !== confirmPassword) {
							showToast('Konfirmasi password tidak cocok.', 'error');
							return;
						}

						saveBtn.disabled = true;
						saveBtn.textContent = 'Menyimpan...';

						const { error } = await supabase.auth.updateUser({ password: newPassword });

						if (error) {
							showToast('Gagal mengubah password: ' + error.message, 'error', error);
						} else {
							showToast('Password berhasil diubah!');
							changePasswordModal.classList.add('hidden');
							changePasswordForm.reset();
						}

						saveBtn.disabled = false;
						saveBtn.textContent = 'Simpan Password';
					});
				    
				    await renderView('home');
				    checkPendingComments();
				    listenForCommentChanges();
					initializePresenceListener();
				}

	            initializePage();
	        });
	    </script>
	</body>
</html>

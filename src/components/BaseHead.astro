---
import { SEO } from 'astro-seo';
import { SITE } from '../consts';

interface Props {
  title: string
  description: string
  image?: string
}

const { title, description, image = "/open-graph.png" } = Astro.props;
const canonicalURL = new URL(Astro.url.pathname, Astro.site);
---

<!-- Pre-render theme before style loads (prevent FOUC) -->
<script is:inline>
  (function () {
    const key = 'theme-preference';
    const saved = localStorage.getItem(key) || 'system';
    const systemDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
    const isDark = saved === 'dark' || (saved === 'system' && systemDark);
    if (isDark) {
      document.documentElement.classList.add('dark');
    } else {
      document.documentElement.classList.remove('dark');
    }
  })();
</script>



<!-- SEO & Meta -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="generator" content={Astro.generator} />
<meta name="color-scheme" content="light dark" />
<meta name="apple-mobile-web-app-title" content={title} />

<!-- Favicon -->
<link rel="icon" href="/favicon.svg" type="image/svg+xml" />
<link rel="apple-touch-icon" href="/apple-touch-icon.png" />
<link rel="manifest" href="/site.webmanifest" />

<!-- Font preload -->
<link rel="preload" href="/fonts/atkinson-regular.woff" as="font" type="font/woff" crossorigin="anonymous" />
<link rel="preload" href="/fonts/atkinson-bold.woff" as="font" type="font/woff" crossorigin="anonymous" />

<!-- SEO Plugin -->
<SEO
  title={title}
  description={description}
  canonical={canonicalURL.toString()}
  twitter={{
    card: "summary_large_image",
    site: "@bimaakbarmusic"
  }}
  openGraph={{
    basic: {
      title: title,
      type: "website",
      image: new URL(image, Astro.site).toString(),
      url: canonicalURL.toString()
    },
    optional: {
      siteName: SITE.TITLE,
      description: description
    }
  }}
/>

<script is:inline>
  const storageKey = "theme";
  const themeOrder = ["light", "dark", "system"];

  function applyTheme(theme) {
    if (theme === "system") {
      const prefersDark = window.matchMedia("(prefers-color-scheme: dark)").matches;
      document.documentElement.classList.toggle("dark", prefersDark);
    } else {
      document.documentElement.classList.toggle("dark", theme === "dark");
    }
  }

  function moveIndicator(index) {
    const indicator = document.getElementById("theme-indicator");
    indicator.style.transform = `translateX(${index * 100}%)`;
  }

  function updateActiveButton(index) {
    const buttons = document.querySelectorAll(".theme-btn");
    buttons.forEach((btn, i) => {
      if (i === index) {
        btn.classList.add("active");
      } else {
        btn.classList.remove("active");
      }
    });
  }

  function setupThemeButtons() {
    const buttons = document.querySelectorAll(".theme-btn");
    buttons.forEach((btn, index) => {
      btn.addEventListener("click", () => {
        const selected = btn.dataset.theme;
        localStorage.setItem(storageKey, selected);
        applyTheme(selected);
        moveIndicator(index);
        updateActiveButton(index);
      });
    });
  }

  function loadTheme() {
    const saved = localStorage.getItem(storageKey) || "system";
    const index = themeOrder.indexOf(saved);
    applyTheme(saved);
    moveIndicator(index);
    updateActiveButton(index);
  }
  function toggleDrawer() {
    const drawer = document.getElementById("drawer");
    const button = document.getElementById("header-drawer-button");
    drawer?.classList.toggle("open");
    button?.classList.toggle("open");
  }

  function initDrawer() {
    const button = document.getElementById("header-drawer-button");
    button?.addEventListener("click", toggleDrawer);
  }
  document.addEventListener("astro:after-swap", initDrawer);
  document.addEventListener("DOMContentLoaded", () => {
    loadTheme();
    setupThemeButtons();
    initDrawer();
  });
</script>

